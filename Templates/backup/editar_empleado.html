<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Empleado</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primario: #0d6efd;
            --color-secundario: #6c757d;
            --color-exito: #198754;
            --color-peligro: #dc3545;
            --color-advertencia: #ffc107;
            --color-info: #0dcaf0;
            --color-fondo: #f8f9fa;
            --color-superficie: #ffffff;
            --sombra-suave: 0 4px 8px rgba(0,0,0,0.05);
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: var(--color-fondo); color: #333; }
        .container { max-width: 1400px; margin: 2em auto; padding: 2em; background-color: var(--color-superficie); border-radius: 12px; box-shadow: var(--sombra-suave); }
        h1, h2 { color: #333; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
        form { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 0.5em; font-weight: 500; font-size: 0.9em; color: #555; }
        input, select { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
        input:focus, select:focus { border-color: var(--color-primario); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25); outline: none; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        hr { grid-column: 1 / -1; border: 0; border-top: 1px solid #eee; margin: 1em 0; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; text-decoration: none; transition: all 0.2s ease; }
        .btn-warning { background-color: var(--color-advertencia); color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        #campos_desvinculacion { display: none; grid-column: 1 / -1; }
        .desvinculacion-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border: 1px solid var(--color-peligro); background-color: #fff6f6; padding: 1em; border-radius: 8px; }
        a.back-link { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 2em; color: var(--color-primario); text-decoration: none; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <a href="{{ url_for('index', query=request.args.get('query', ''), search_by=request.args.get('search_by', '')) }}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
            Volver a la lista
        </a>
        <h1>Editando a: <strong>{{ empleado.nombre_completo }}</strong></h1>
        <form action="{{ url_for('actualizar_empleado', id=empleado.id) }}" method="post">
            <input type="hidden" name="query" value="{{ request.args.get('query', '') }}">
            <input type="hidden" name="search_by" value="{{ request.args.get('search_by', '') }}">

            <div class="form-group"> <label for="rut">RUT / Pasaporte:</label> <input type="text" id="rut" name="rut" value="{{ empleado.rut }}" required> </div>
            <div class="form-group"> <label for="nombre_completo">Nombre Completo:</label> <input type="text" id="nombre_completo" name="nombre_completo" value="{{ empleado.nombre_completo }}" required> </div>
            <div class="form-group"> <label for="fecha_nacimiento">Fecha de Nacimiento:</label> <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" value="{{ empleado.fecha_nacimiento or '' }}"> </div>
            <div class="form-group"> <label for="edad_calculada">Edad (calculada):</label> <input type="text" id="edad_calculada" readonly> </div>
            <div class="form-group"> <label for="telefono">Teléfono:</label> <input type="tel" id="telefono" name="telefono" value="{{ empleado.telefono or '' }}"> </div>
            <div class="form-group"> <label for="correo_electronico">Correo Electrónico:</label> <input type="email" id="correo_electronico" name="correo_electronico" value="{{ empleado.correo_electronico or '' }}"> </div>
            <div class="form-group" style="grid-column: 1 / -1;"> <label for="direccion">Dirección:</label> <input type="text" id="direccion" name="direccion" value="{{ empleado.direccion or '' }}"> </div>
            <div class="form-group"> <label for="genero_id">Género:</label> <select id="genero_id" name="genero_id"> {% for item in generos %}<option value="{{ item.id }}" {% if item.id == empleado.genero_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="nacionalidad_id">Nacionalidad:</label> <select id="nacionalidad_id" name="nacionalidad_id"> {% for nac in nacionalidades %}<option value="{{ nac.id }}" {% if nac.id == empleado.nacionalidad_id %}selected{% endif %}>{{ nac.pais }}</option>{% endfor %} </select> </div>
            <hr>
            
            <div class="form-group"> <label for="id_sap_global">ID SAP Global (No editable):</label> <input type="text" id="id_sap_global" name="id_sap_global" value="{{ empleado.id_sap_global or '' }}" readonly> </div>
            <div class="form-group"> <label for="id_sap_local">ID SAP Local:</label> <input type="text" id="id_sap_local" name="id_sap_local" value="{{ empleado.id_sap_local or '' }}"> </div>
            <div class="form-group"> <label for="nomina_id">Nómina:</label> <select id="nomina_id" name="nomina_id"> {% for item in nominas %}<option value="{{ item.id }}" {% if item.id == empleado.nomina_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <hr>

            <div class="form-group"> <label for="fecha_ingreso">Fecha de Ingreso:</label> <input type="date" id="fecha_ingreso" name="fecha_ingreso" value="{{ empleado.fecha_ingreso }}" required> </div>
            <div class="form-group"> <label for="tipo_contrato_id">Tipo de Contrato:</label> <select id="tipo_contrato_id" name="tipo_contrato_id"> {% for item in tipos_contrato %}<option value="{{ item.id }}" {% if item.id == empleado.tipo_contrato_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="relacion_laboral_id">Relación Laboral:</label> <select id="relacion_laboral_id" name="relacion_laboral_id"> {% for item in relaciones_laborales %}<option value="{{ item.id }}" {% if item.id == empleado.relacion_laboral_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <hr>

            <div class="form-group"> <label for="area_id">Área:</label> <select id="area_id" name="area_id"> {% for item in areas %}<option value="{{ item.id }}" {% if item.id == empleado.area_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="cargo_id">Cargo:</label> <select id="cargo_id" name="cargo_id" required> {% for cargo in cargos %}<option value="{{ cargo.id }}" {% if cargo.id == empleado.cargo_id %}selected{% endif %}>{{ cargo.nombre }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="supervision_id">Supervisión:</label> <select id="supervision_id" name="supervision_id"> {% for item in supervisiones %}<option value="{{ item.id }}" {% if item.id == empleado.supervision_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <hr>

            <div class="form-group"> <label for="turno_id">Turno:</label> <select id="turno_id" name="turno_id" required> {% for turno in turnos %}<option value="{{ turno.id }}" {% if turno.id == empleado.turno_id %}selected{% endif %}>{{ turno.nombre }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="fase_id">Fase:</label> <select id="fase_id" name="fase_id"> {% for item in fases %}<option value="{{ item.id }}" {% if item.id == empleado.fase_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="distribucion_categoria_id">Distribución Categoría:</label> <select id="distribucion_categoria_id" name="distribucion_categoria_id"> {% for item in distribucion_categorias %}<option value="{{ item.id }}" {% if item.id == empleado.distribucion_categoria_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <hr>

            <div class="form-group"> <label for="region_id">Región:</label> <select id="region_id" name="region_id" required> {% for region in regiones %}<option value="{{ region.id }}" {% if region.id == empleado.region_id %}selected{% endif %}>{{ region.region }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="comuna_id">Comuna:</label> <select id="comuna_id" name="comuna_id" required> {% for comuna in comunas %}<option value="{{ comuna.id }}" {% if comuna.id == empleado.comuna_id %}selected{% endif %}>{{ comuna.comuna }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="tipo_pasaje_id">Tipo de Pasaje (automático):</label> <select id="tipo_pasaje_id" name="tipo_pasaje_id"> {% for item in tipos_pasaje %}<option value="{{ item.id }}" {% if item.id == empleado.tipo_pasaje_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <hr>
            
            <div class="form-group"> <label for="acreditacion_id">Acreditación:</label> <select id="acreditacion_id" name="acreditacion_id"> {% for item in acreditaciones %}<option value="{{ item.id }}" {% if item.id == empleado.acreditacion_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            <div class="form-group"> <label for="status_id">Status:</label> <select id="status_id" name="status_id"> {% for item in status_empleado %}<option value="{{ item.id }}" {% if item.id == empleado.status_id %}selected{% endif %}>{{ item.nombre }}</option>{% endfor %} </select> </div>
            
            <hr>

            <div id="campos_desvinculacion">
                <h2>Información de Desvinculación</h2>
                <div class="desvinculacion-grid">
                    <div class="form-group">
                        <label for="fecha_egreso">Fecha de Egreso:</label>
                        <input type="date" id="fecha_egreso" name="fecha_egreso" value="{{ empleado.fecha_egreso or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="causal_despido_id">Causal de Despido:</label>
                        <select id="causal_despido_id" name="causal_despido_id">
                             <option value="">-- Ninguna --</option>
                             {% for item in causales_despido %}
                                <option value="{{ item.id }}" {% if item.id == empleado.causal_despido_id %}selected{% endif %}>
                                    {{ item.nombre_causal }} ({{ item.articulo_codigo }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
                <button type="submit" class="btn btn-warning">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z"/></svg>
                    Actualizar Empleado
                </button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const regionSelect = document.getElementById('region_id');
            const comunaSelect = document.getElementById('comuna_id');
            const statusSelect = document.getElementById('status_id');
            const desvinculacionDiv = document.getElementById('campos_desvinculacion');
            const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
            const edadDisplay = document.getElementById('edad_calculada');
            const tipoPasajeSelect = document.getElementById('tipo_pasaje_id');

            function toggleDesvinculacion() {
                const selectedStatusText = statusSelect.options[statusSelect.selectedIndex].text;
                desvinculacionDiv.style.display = (selectedStatusText === 'Desvinculado') ? 'block' : 'none';
            }
            statusSelect.addEventListener('change', toggleDesvinculacion);
            
            function calcularEdad() {
                if (!fechaNacimientoInput.value) { edadDisplay.value = ''; return; }
                const hoy = new Date();
                const nacimiento = new Date(fechaNacimientoInput.value);
                let edad = hoy.getFullYear() - nacimiento.getFullYear();
                const m = hoy.getMonth() - nacimiento.getMonth();
                if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) { edad--; }
                edadDisplay.value = edad >= 0 ? `${edad} años` : '';
            }
            fechaNacimientoInput.addEventListener('change', calcularEdad);

            function actualizarTipoPasaje() {
                const regionId = parseInt(regionSelect.value, 10);
                let pasajeId; 
                if (regionId >= 6 && regionId <= 16) { pasajeId = 1; } 
                else if (regionId >= 1 && regionId <= 5) { pasajeId = 2; } 
                else { pasajeId = 3; }
                tipoPasajeSelect.value = pasajeId;
            }
            regionSelect.addEventListener('change', actualizarTipoPasaje);
            
            toggleDesvinculacion();
            calcularEdad();
        });
    </script>
</body>
</html>