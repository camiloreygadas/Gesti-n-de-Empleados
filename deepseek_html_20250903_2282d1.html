<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral de Gestión de Empleados</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SheetJS (para Excel) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
    /* ===================================================================== */
    /* ESTILOS UNIFICADOS PARA EL SISTEMA DE GESTIÓN DE EMPLEADOS           */
    /* ===================================================================== */
    
    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-tertiary: #e9ecef;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --text-muted: #adb5bd;
        --border-color: #dee2e6;
        --accent-color: #0d6efd;
        --success-color: #198754;
        --danger-color: #dc3545;
        --warning-color: #fd7e14;
        --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --card-hover: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    [data-bs-theme="dark"] {
        --bg-primary: #212529;
        --bg-secondary: #343a40;
        --bg-tertiary: #495057;
        --text-primary: #ffffff;
        --text-secondary: #adb5bd;
        --text-muted: #6c757d;
        --border-color: #495057;
        --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.5);
        --gradient-bg: linear-gradient(135deg, #434343 0%, #000000 100%);
        --card-hover: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
    }

    [data-bs-theme="dark"] .bg-light {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
    }

    [data-bs-theme="dark"] .card-body.bg-light {
        background-color: var(--bg-secondary) !important;
    }

    [data-bs-theme="dark"] .text-muted {
        color: var(--text-secondary) !important;
    }

    * {
        transition: all 0.3s ease;
    }

    body {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* ESTILOS PARA DRAG & DROP AVANZADO */
    .upload-section {
        margin: 2rem 0;
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    }

    .dropzone-container {
        margin: 1rem 0;
    }

    .dropzone {
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #fafbfc;
        position: relative;
        overflow: hidden;
    }

    .dropzone.drag-over {
        border-color: #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
        transform: scale(1.02);
    }

    .dropzone.drag-over::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
        animation: shimmer 1s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .dropzone.uploading {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.05);
        pointer-events: none;
    }

    .dropzone.error {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.05);
    }

    .dropzone.success {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }

    .upload-icon {
        font-size: 4rem;
        color: #6c757d;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .dropzone.drag-over .upload-icon {
        color: #28a745;
        transform: scale(1.2);
    }

    .upload-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .upload-description {
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .btn-link {
        color: #007bff;
        text-decoration: none;
        background: none;
        border: none;
        padding: 0;
        font-weight: 500;
    }

    .btn-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }

    .upload-info {
        background: rgba(255, 255, 255, 0.8);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        display: inline-block;
    }

    .file-preview {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .file-icon {
        font-size: 3rem;
        min-width: 60px;
        text-align: center;
    }

    .file-details {
        flex-grow: 1;
    }

    .file-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.25rem 0;
        color: #495057;
    }

    .file-size {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
    }

    .file-progress {
        margin-top: 0.5rem;
    }

    .progress {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
        overflow: hidden;
    }

    .progress-bar {
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .progress-text {
        display: block;
        margin-top: 0.25rem;
        color: #6c757d;
        font-size: 0.8rem;
    }

    .file-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .upload-options {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
    }

    .form-check-label {
        font-weight: 500;
        color: #495057;
    }

    .template-section .alert {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .upload-results, .validation-errors {
        margin-top: 2rem;
        animation: slideDown 0.5s ease;
    }

    @keyframes slideDown {
        from { 
            opacity: 0; 
            transform: translateY(-20px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }

    .results-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .result-stat {
        background: rgba(255, 255, 255, 0.3);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }

    .result-number {
        font-size: 2rem;
        font-weight: 700;
        color: #495057;
    }

    .result-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .instruction-step {
        padding: 1.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .instruction-step:last-child {
        border-bottom: none;
    }

    .instruction-step h6 {
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
    }

    .instruction-step ul li {
        margin-bottom: 0.25rem;
    }

    /* Estados de carga */
    .uploading .upload-icon {
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ESTILOS PARA SISTEMA DE MODALES AVANZADOS */
    .modal-xl {
        max-width: 1200px;
    }

    .modal-header {
        border: none;
        padding: 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .modal-title-container {
        flex-grow: 1;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    .modal-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .modal-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .modal-progress {
        padding: 0;
        background: rgba(255, 255, 255, 0.1);
    }

    .modal-body {
        padding: 2rem;
    }

    /* Step Navigation */
    .step-navigation {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .steps-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .steps-container::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 50px;
        right: 50px;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        z-index: 2;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.5rem;
        border-radius: 10px;
    }

    .step:hover {
        background: rgba(0, 123, 255, 0.05);
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .step-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
        max-width: 100px;
    }

    .step.active .step-number {
        background: #007bff;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .step.active .step-label {
        color: #007bff;
        font-weight: 600;
    }

    .step.completed .step-number {
        background: #28a745;
        color: white;
    }

    .step.completed .step-label {
        color: #28a745;
    }

    .step.completed .step-number::before {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
    }

    /* Step Content */
    .step-content {
        display: none;
        animation: fadeInStep 0.3s ease;
    }

    .step-content.active {
        display: block;
    }

    @keyframes fadeInStep {
        from { 
            opacity: 0; 
            transform: translateX(20px); 
        }
        to { 
            opacity: 1; 
            transform: translateX(0); 
        }
    }

    .step-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .step-header h5 {
        margin: 0 0 0.5rem 0;
        font-size: 1.25rem;
    }

    /* Form Styling */
    .form-label.required::after {
        content: ' *';
        color: #dc3545;
    }

    .input-group .btn {
        border-left: none;
    }

    .form-feedback {
        margin-top: 0.25rem;
        font-size: 0.85rem;
    }

    .form-feedback.valid {
        color: #28a745;
    }

    .form-feedback.invalid {
        color: #dc3545;
    }

    .form-control.is-valid, .form-select.is-valid {
        border-color: #28a745;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.94.94 4.94-4.94L7.27 1.8 3.24 5.84 2.3 6.73z'/%3e%3c/svg%3e");
    }

    .form-control.is-invalid, .form-select.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12'%3e%3cpath fill='%23dc3545' d='M3 9l6-6m-6 0l6 6'/%3e%3c/svg%3e");
    }

    /* Contract Preview */
    .contract-preview {
        border-left: 4px solid #17a2b8;
    }

    .contract-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .contract-detail {
        background: rgba(255, 255, 255, 0.5);
        padding: 0.75rem;
        border-radius: 5px;
    }

    .contract-detail strong {
        display: block;
        color: #495057;
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    /* Org Chart Preview */
    .org-chart {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .org-level {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0.5rem 0;
        position: relative;
    }

    .org-item {
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 0 0.5rem;
        font-weight: 500;
        border: 2px solid transparent;
    }

    .org-item.highlight {
        border-color: #007bff;
        background: #e3f2fd;
    }

    .org-connection {
        position: absolute;
        width: 2px;
        height: 20px;
        background: #dee2e6;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
    }

    /* Review Section */
    .review-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .review-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        border-left: 4px solid #007bff;
    }

    .review-card h6 {
        color: #495057;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .review-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }

    .review-item:last-child {
        border-bottom: none;
    }

    .review-label {
        font-weight: 500;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .review-value {
        color: #495057;
        font-weight: 600;
    }

    .review-value.empty {
        color: #adb5bd;
        font-style: italic;
    }

    /* Modal Footer */
    .modal-footer {
        border: none;
        padding: 1.5rem 2rem;
        background: #f8f9fa;
    }

    .footer-content {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .validation-summary {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .validation-count {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .validation-count.valid {
        background: #d4edda;
        color: #155724;
    }

    .validation-count.invalid {
        background: #f8d7da;
        color: #721c24;
    }

    .modal-buttons {
        display: flex;
        gap: 0.5rem;
    }

    /* Loading Modal */
    .loading-animation {
        position: relative;
    }

    .loading-animation::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 5rem;
        height: 5rem;
        border: 3px solid rgba(0, 123, 255, 0.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .loading-title {
        color: #495057;
        font-weight: 600;
    }

    .progress-section {
        background: rgba(248, 249, 250, 0.8);
        padding: 1rem;
        border-radius: 10px;
    }

    .progress-steps {
        text-align: left;
        margin-top: 0.5rem;
    }

    .connection-status {
        padding: 0.5rem;
        background: rgba(40, 167, 69, 0.1);
        border-radius: 5px;
    }

    /* ESTILOS PARA IMPORTACIÓN CON VALIDACIÓN EN TIEMPO REAL */
    .bg-gradient-import {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    }

    .import-header-info h4 {
        margin: 0;
        font-size: 1.5rem;
    }

    .import-progress-steps {
        padding: 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        position: relative;
    }

    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 25%;
        right: 25%;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .step-title {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    .step.active .step-number {
        background: #28a745;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .step.active .step-title {
        color: #28a745;
        font-weight: 600;
    }

    .step.completed .step-number {
        background: #007bff;
        color: white;
    }

    .step.completed .step-number::before {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
    }

    .import-step {
        display: none;
        animation: fadeInStep 0.3s ease;
    }

    .import-step.active {
        display: block;
    }

    /* File Upload Advanced */
    .file-upload-advanced {
        padding: 2rem 0;
    }

    .upload-options {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
    }

    .drag-drop-zone {
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 4rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        position: relative;
        overflow: hidden;
    }

    .drag-drop-zone.drag-over {
        border-color: #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
        transform: scale(1.02);
    }

    .drag-drop-zone.drag-over::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
        animation: shimmerImport 1s infinite;
    }

    @keyframes shimmerImport {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .upload-icon {
        font-size: 4rem;
        color: #6c757d;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .drag-drop-zone.drag-over .upload-icon {
        color: #28a745;
        transform: scale(1.2);
    }

    .supported-formats {
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        display: inline-block;
    }

    /* Validation Progress */
    .validation-progress {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .validation-stats {
        display: flex;
        gap: 1.5rem;
        font-size: 0.9rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .validation-log {
        background: #f8f9fa;
        border-radius: 5px;
        padding: 1rem;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
    }

    .log-entry {
        padding: 0.25rem 0;
        border-bottom: 1px solid #e9ecef;
        animation: slideInLog 0.3s ease;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    @keyframes slideInLog {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .log-entry.success { color: #28a745; }
    .log-entry.warning { color: #ffc107; }
    .log-entry.error { color: #dc3545; }
    .log-entry.info { color: #17a2b8; }

    /* Data Preview Table */
    .data-preview {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
    }

    #preview-table {
        font-size: 0.85rem;
    }

    #preview-table .table-dark th {
        font-size: 0.8rem;
        padding: 0.5rem;
    }

    #preview-table td {
        padding: 0.5rem;
        vertical-align: middle;
    }

    .cell-valid {
        background: rgba(40, 167, 69, 0.1) !important;
        border-left: 3px solid #28a745;
    }

    .cell-warning {
        background: rgba(255, 193, 7, 0.1) !important;
        border-left: 3px solid #ffc107;
    }

    .cell-error {
        background: rgba(220, 53, 69, 0.1) !important;
        border-left: 3px solid #dc3545;
    }

    .cell-corrected {
        background: rgba(23, 162, 184, 0.1) !important;
        border-left: 3px solid #17a2b8;
        position: relative;
    }

    .cell-corrected::after {
        content: '✓';
        position: absolute;
        top: 2px;
        right: 2px;
        color: #17a2b8;
        font-size: 0.7rem;
    }

    /* Error Correction */
    .error-correction {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
    }

    .correction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .correction-actions {
        display: flex;
        gap: 0.5rem;
    }

    .error-item {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .error-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .error-header {
        display: flex;
        justify-content: between;
        align-items: start;
        margin-bottom: 0.5rem;
    }

    .error-info {
        flex-grow: 1;
    }

    .error-row {
        font-weight: 600;
        color: #856404;
        margin-bottom: 0.25rem;
    }

    .error-message {
        color: #856404;
        font-size: 0.9rem;
    }

    .error-suggestion {
        background: rgba(23, 162, 184, 0.1);
        border-left: 3px solid #17a2b8;
        padding: 0.75rem;
        margin-top: 0.75rem;
        border-radius: 0 5px 5px 0;
    }

    .error-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    /* Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .summary-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .summary-card.success {
        border-left-color: #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, rgba(40, 167, 69, 0.1) 100%);
    }

    .summary-card.warning {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 193, 7, 0.1) 100%);
    }

    .summary-card.danger {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, rgba(220, 53, 69, 0.1) 100%);
    }

    .summary-card.info {
        border-left-color: #17a2b8;
        background: linear-gradient(135deg, rgba(23, 162, 184, 0.05) 0%, rgba(23, 162, 184, 0.1) 100%);
    }

    .card-icon {
        font-size: 2rem;
    }

    .card-icon i {
        color: inherit;
    }

    .summary-card.success .card-icon { color: #28a745; }
    .summary-card.warning .card-icon { color: #ffc107; }
    .summary-card.danger .card-icon { color: #dc3545; }
    .summary-card.info .card-icon { color: #17a2b8; }

    .card-number {
        font-size: 2rem;
        font-weight: 700;
        color: #495057;
    }

    .card-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Import Progress Modal */
    .import-animation {
        position: relative;
    }

    .spinner-container {
        position: relative;
        display: inline-block;
    }

    .spinner-inner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
    }

    .progress-detailed .progress {
        border-radius: 10px;
        overflow: hidden;
    }

    .bg-gradient-success {
        background: linear-gradient(90deg, #28a745, #20c997) !important;
    }

    .live-updates {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        max-height: 120px;
        overflow-y: auto;
        text-align: left;
    }

    .update-line {
        font-size: 0.85rem;
        color: #6c757d;
        padding: 0.25rem 0;
        border-bottom: 1px solid #e9ecef;
        animation: fadeInUpdate 0.3s ease;
    }

    .update-line:last-child {
        border-bottom: none;
        color: #28a745;
        font-weight: 500;
    }

    @keyframes fadeInUpdate {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* ESTILOS ESPECÍFICOS PARA LA GESTIÓN DE EMPLEADOS */
    .escape-container {
        width: 100vw !important;
        position: relative !important;
        left: 50% !important;
        right: 50% !important;
        margin-left: -50vw !important;
        margin-right: -50vw !important;
        max-width: none !important;
    }

    .content-wrapper {
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }

    @media (min-width: 768px) {
        .content-wrapper {
            padding-left: 4rem !important;
            padding-right: 4rem !important;
        }
    }

    @media (min-width: 1200px) {
        .content-wrapper {
            padding-left: 6rem !important;
            padding-right: 6rem !important;
        }
    }

    @media (min-width: 1400px) {
        .content-wrapper {
            padding-left: 8rem !important;
            padding-right: 8rem !important;
        }
    }

    /* ESPACIADO DESKTOP ESPECÍFICO */
    @media (min-width: 1200px) {
        /* Cards más espaciosas */
        .card {
            margin-bottom: 2.5rem !important;
            border-radius: 1rem !important;
            box-shadow: var(--shadow-lg) !important;
            background: var(--bg-primary) !important;
        }
        
        .card-body {
            padding: 3rem !important;
        }
        
        .card-header {
            padding: 2rem 3rem !important;
            background: var(--bg-secondary) !important;
            border-bottom: 1px solid var(--border-color) !important;
            border-radius: 1rem 1rem 0 0 !important;
        }
        
        .card-header h5 {
            font-size: 1.5rem !important;
            margin-bottom: 0 !important;
            color: var(--text-primary) !important;
        }
        
        /* Tabla más espaciosa */
        .table th, .table td {
            padding: 1.5rem 2rem !important;
            font-size: 1rem !important;
            vertical-align: middle !important;
        }
        
        .table th {
            background: var(--bg-tertiary) !important;
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            border: none !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
        }
        
        .table td {
            border: none !important;
            border-bottom: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        
        .table tbody tr:hover {
            background: var(--bg-secondary) !important;
            transform: scale(1.002) !important;
        }
        
        /* Formularios más espaciosos */
        .form-control, .form-select {
            padding: 1rem 1.5rem !important;
            font-size: 1rem !important;
            min-height: 3.5rem !important;
            border-radius: 0.75rem !important;
            border: 2px solid var(--border-color) !important;
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1) !important;
            transform: translateY(-1px) !important;
        }
        
        .form-label {
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            margin-bottom: 0.75rem !important;
            color: var(--text-primary) !important;
        }
        
        /* Botones más espaciosos */
        .btn {
            padding: 1rem 2rem !important;
            font-size: 1rem !important;
            min-height: 3.5rem !important;
            border-radius: 0.75rem !important;
            font-weight: 500 !important;
            border: none !important;
            transition: all 0.3s ease !important;
        }
        
        .btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: var(--card-hover) !important;
        }
        
        /* Tabs más espaciosos */
        .nav-tabs {
            border: none !important;
            background: var(--bg-primary) !important;
            border-radius: 1rem 1rem 0 0 !important;
            padding: 1.5rem 1.5rem 0 !important;
        }
        
        .nav-tabs .nav-link {
            padding: 1.5rem 2.5rem !important;
            font-size: 1.1rem !important;
            font-weight: 500 !important;
            border: none !important;
            border-radius: 0.75rem 0.75rem 0 0 !important;
            color: var(--text-secondary) !important;
            margin-right: 0.5rem !important;
            transition: all 0.3s ease !important;
        }
        
        .nav-tabs .nav-link:hover {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            transform: translateY(-2px) !important;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--accent-color) !important;
            color: white !important;
        }
        
        /* Tab content más espacioso */
        .tab-pane {
            padding: 3rem !important;
        }
        
        /* Row gaps más amplios */
        .row.g-3, .row.g-4 {
            --bs-gutter-x: 2.5rem !important;
            --bs-gutter-y: 2rem !important;
        }
        
        /* Navegación principal */
        .nav-btn {
            min-width: 300px !important;
            padding: 1.5rem 2.5rem !important;
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            border-radius: 1rem !important;
            text-decoration: none !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 1rem !important;
            transition: all 0.3s ease !important;
            background: rgba(255, 255, 255, 0.95) !important;
            color: var(--accent-color) !important;
            border: 2px solid rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        .nav-btn:hover {
            background: var(--accent-color) !important;
            color: white !important;
            transform: translateY(-3px) scale(1.02) !important;
            text-decoration: none !important;
        }
    }

    /* Theme Toggle */
    .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 50px;
        padding: 0.75rem 1.25rem;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
    }

    .theme-toggle:hover {
        transform: translateY(-2px);
    }

    .theme-toggle-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }

    .theme-toggle-btn:hover {
        background: var(--bg-tertiary);
        transform: scale(1.1);
    }

    /* Header mejorado */
    .header-gradient {
        background: var(--gradient-bg);
        padding: 4rem 0;
        margin-bottom: 3rem;
        position: relative;
        overflow: hidden;
        /* Hacer que el header también escape del container */
        width: 100vw;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
    }

    .header-gradient::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%);
        animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .header-title {
        color: white;
        font-weight: 700;
        font-size: 3rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        margin: 0;
    }

    @media (max-width: 767px) {
        .header-title {
            font-size: 2rem;
        }
    }

    /* Campos clickeables mejorados */
    .clickable-field {
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        display: inline-block;
        font-weight: 500;
    }

    .clickable-field:hover {
        background: var(--accent-color);
        color: white;
        transform: scale(1.05);
        text-decoration: none;
    }

    .clickable-field.selected {
        background: var(--success-color) !important;
        color: white !important;
        box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.2);
    }

    /* Badges mejorados */
    .badge {
        border-radius: 0.75rem;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* Alertas mejoradas */
    .alert {
        border: none;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        backdrop-filter: blur(10px);
    }

    .alert-info {
        background: rgba(13, 202, 240, 0.1);
        color: var(--text-primary);
        border-left: 4px solid #0dcaf0;
    }

    /* Responsive mejoras */
    @media (max-width: 767px) {
        .content-wrapper {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        
        .card-body {
            padding: 1.5rem !important;
        }
        
        .table th, .table td {
            padding: 0.75rem 0.5rem !important;
            font-size: 0.9rem !important;
        }
        
        .theme-toggle {
            position: relative;
            top: auto;
            right: auto;
            margin-bottom: 1rem;
        }
    }

    /* Indicador de éxito */
    .success-indicator {
        position: fixed;
        top: 70px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        font-weight: bold;
        z-index: 9999;
        box-shadow: var(--shadow-lg);
    }
    ::-webkit-scrollbar {
        width: 12px;
    }
    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }
    ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 6px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }

    .modern-clock {
        position: absolute;
        top: 30px;
        right: 30px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        z-index: 1000;
    }

    .modern-clock:hover {
        transform: scale(1.1) rotate(2deg);
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .clock-face {
        width: 60px;
        height: 60px;
        border: 3px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        position: relative;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: clockGlow 3s ease-in-out infinite;
    }

    @keyframes clockGlow {
        0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.3); }
        50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.6); }
    }

    .clock-center {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
    }

    .hour-hand {
        position: absolute;
        top: 30%;
        left: 49%;
        width: 3px;
        height: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 2px;
        transform-origin: bottom center;
        transition: transform 0.5s ease;
    }

    .minute-hand {
        position: absolute;
        top: 20%;
        left: 49%;
        width: 2px;
        height: 25px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 1px;
        transform-origin: bottom center;
        transition: transform 0.5s ease;
    }

    .second-hand {
        position: absolute;
        top: 15%;
        left: 49.5%;
        width: 1px;
        height: 28px;
        background: #ff6b6b;
        transform-origin: bottom center;
        transition: transform 0.1s ease;
        animation: tick 1s steps(60) infinite;
    }

    @keyframes tick {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .digital-time {
        color: white;
        text-align: center;
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }

    .time-display {
        font-size: 18px;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        animation: digitalPulse 2s ease-in-out infinite;
    }

    @keyframes digitalPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .session-display {
        font-size: 12px;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }

    .modern-clock:hover .session-display {
        opacity: 1;
        animation: sessionGlow 1s ease-in-out;
    }

    @keyframes sessionGlow {
        0%, 100% { text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
        50% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
    }

    /* ESTILOS DE PAGINACIÓN MEJORADOS */
    .pagination .page-link {
        font-size: 1rem !important;
        padding: 0.75rem 1.5rem !important;
        border-radius: 0.5rem !important;
        margin: 0 0.25rem;
    }

    .pagination .page-item.active .page-link {
        background-color: var(--accent-color) !important;
        border-color: var(--accent-color) !important;
        color: white !important;
    }

    .pagination .page-item:not(.active) .page-link:hover {
        background-color: var(--bg-tertiary) !important;
        transform: translateY(-1px) scale(1.02);
    }

    /* SISTEMA DE NOTIFICACIONES TOAST */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
        pointer-events: none;
    }

    .toast-notification {
        background: var(--bg-primary);
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border-left: 4px solid;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transform: translateX(100%);
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        pointer-events: all;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .toast-notification:hover {
        transform: translateX(-10px) scale(1.02);
        box-shadow: var(--card-hover);
    }

    .toast-notification.toast-success {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.1), var(--bg-primary));
    }

    .toast-notification.toast-error {
        border-left-color: var(--danger-color);
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), var(--bg-primary));
    }

    .toast-notification.toast-warning {
        border-left-color: var(--warning-color);
        background: linear-gradient(135deg, rgba(253, 126, 20, 0.1), var(--bg-primary));
    }

    .toast-notification.toast-info {
        border-left-color: var(--accent-color);
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), var(--bg-primary));
    }

    .toast-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        color: var(--text-primary);
        font-weight: 500;
    }

    .toast-content i {
        font-size: 18px;
        opacity: 0.8;
    }

    .toast-success .toast-content i {
        color: var(--success-color);
    }

    .toast-error .toast-content i {
        color: var(--danger-color);
    }

    .toast-warning .toast-content i {
        color: var(--warning-color);
    }

    .toast-info .toast-content i {
        color: var(--accent-color);
    }

    .toast-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        padding: 0 5px;
        transition: all 0.3s ease;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toast-close:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        transform: rotate(90deg);
    }

    .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: currentColor;
        border-radius: 0 0 12px 12px;
        opacity: 0.3;
        animation: progress 4s linear forwards;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
            max-height: 100px;
            margin-bottom: 10px;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
            max-height: 0;
            margin-bottom: 0;
            padding: 0;
        }
    }

    @keyframes progress {
        from {
            width: 100%;
        }
        to {
            width: 0%;
        }
    }

    .toast-notification.removing {
        animation: slideOut 0.3s ease-in forwards;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .toast-container {
            right: 10px;
            left: 10px;
            max-width: none;
            top: 70px;
        }
        
        .toast-notification {
            padding: 14px 16px;
        }
    }

    /* Animaciones adicionales */
    .modal.fade .modal-dialog {
        transform: scale(0.8) translateY(-50px);
        transition: all 0.3s ease;
    }

    .modal.show .modal-dialog {
        transform: scale(1) translateY(0);
    }

    /* Estados especiales */
    .step-content.validating {
        opacity: 0.6;
        pointer-events: none;
    }

    .step-content.validated {
        animation: validatedPulse 0.5s ease;
    }

    @keyframes validatedPulse {
        0% { background: rgba(40, 167, 69, 0.1); }
        50% { background: rgba(40, 167, 69, 0.2); }
        100% { background: transparent; }
    }

    /* Responsive para componentes de importación */
    @media (max-width: 768px) {
        .step-indicator {
            flex-direction: column;
            gap: 1rem;
        }
        
        .step-indicator::before {
            display: none;
        }
        
        .progress-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        
        .validation-stats {
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }
        
        .correction-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        
        .correction-actions {
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .summary-cards {
            grid-template-columns: 1fr;
        }
    }
    </style>
</head>
<body data-bs-theme="light">
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" onclick="toggleTheme()" title="Cambiar tema">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
    </div>

    <!-- TODO EL CONTENIDO DENTRO DEL ESCAPE-CONTAINER -->
    <div class="escape-container">
        <div class="content-wrapper">
            
            <!-- Header mejorado -->
            <div class="header-gradient">
                <div class="text-center">
                    <h1 class="header-title">
                        <i class="fas fa-users me-3"></i>
                        Gestión de Empleados
                    </h1>
                    <p class="text-white-50 mb-0 fs-5">Sistema integral de administración de personal</p>
                </div>
                <!-- Reloj Moderno -->
                <div class="modern-clock" id="modern-clock">
                    <div class="clock-face">
                        <div class="clock-center"></div>
                        <div class="hour-hand" id="hour-hand"></div>
                        <div class="minute-hand" id="minute-hand"></div>
                        <div class="second-hand" id="second-hand"></div>
                    </div>
                    <div class="digital-time">
                        <div class="time-display" id="time-display">00:00:00</div>
                        <div class="session-display" id="session-display">Sesión: 00:00:00</div>
                    </div>
                </div>
            </div>

            <!-- Navegación principal más espaciosa -->
            <div class="card shadow-sm mb-5">
                <div class="card-body d-flex justify-content-center flex-wrap gap-4 py-4">
                    <a href="#" class="nav-btn">
                        <i class="fas fa-calendar-check"></i>
                        <span>Ir a Registro de Asistencia</span>
                    </a>
                    <a href="#" class="nav-btn">
                        <i class="fas fa-chart-pie"></i>
                        <span>Módulo de Reportes</span>
                    </a>
                    <a href="#" class="nav-btn">
                        <i class="fas fa-calendar-days"></i>
                        <span>Gestión de Turnos</span>
                    </a>
                </div>
            </div>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista-pane" type="button" role="tab" aria-controls="lista-pane" aria-selected="true">
                        <i class="fas fa-list me-2"></i>Lista de Empleados
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="registrar-tab" data-bs-toggle="tab" data-bs-target="#registrar-pane" type="button" role="tab" aria-controls="registrar-pane" aria-selected="false">
                        <i class="fas fa-user-plus me-2"></i>Registrar Nuevo Empleado
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="herramientas-tab" data-bs-toggle="tab" data-bs-target="#herramientas-pane" type="button" role="tab" aria-controls="herramientas-pane" aria-selected="false">
                        <i class="fas fa-tools me-2"></i>Herramientas Masivas
                    </button>
                </li>
            </ul>

            <div class="tab-content card border-top-0 rounded-bottom" id="myTabContent">
                
                <div class="tab-pane fade show active" id="lista-pane" role="tabpanel" aria-labelledby="lista-tab" tabindex="0">
                    
                    <form action="#" method="get" class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-search me-2"></i>
                                Búsqueda de Empleados
                            </h5>
                        </div>
                        <div class="card-body" style="background-color: var(--bg-secondary);">
                            <div class="row g-4 align-items-end">
                                <div class="col-md-6">
                                    <label for="query" class="form-label">Buscar por RUT o ID SAP</label>
                                    <textarea name="query" id="query" rows="3" class="form-control" placeholder="Pega una lista separada por comas, espacios o saltos de línea."></textarea>
                                </div>
                                <div class="col-md-3">
                                    <label for="search_by" class="form-label">Campo de Búsqueda</label>
                                    <select id="search_by" name="search_by" class="form-select">
                                        <option value="rut">RUT</option>
                                        <option value="id_sap_local">ID SAP Local</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search me-2"></i>Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- BOTONES DE SELECCIÓN RÁPIDA -->
                    <div class="card mb-4">
                        <div class="card-body" style="background-color: var(--bg-secondary);">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex flex-wrap gap-3 align-items-center">
                                        <span class="text-muted fw-bold">Selección rápida:</span>
                                        
                                        <button type="button" id="select-all-visible" class="btn btn-outline-primary">
                                            <i class="fas fa-check-square me-2"></i>Seleccionar todos los visibles
                                        </button>
                                        
                                        <button type="button" id="deselect-all" class="btn btn-outline-secondary">
                                            <i class="fas fa-square me-2"></i>Deseleccionar todos
                                        </button>
                                        
                                        <button type="button" id="invert-selection" class="btn btn-outline-info">
                                            <i class="fas fa-exchange-alt me-2"></i>Invertir selección
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Contador de selección más visible -->
                                <div class="col-md-4 text-end">
                                    <span id="selection-display" class="badge bg-primary fs-6" style="display: none;">
                                        0 empleados seleccionados
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Mensaje contextual -->
                            <div id="selection-message" class="mt-3" style="display: none;">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="message-text"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>
                                Resultados
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="bulk-form" action="#" method="post">
                                <input type="hidden" name="query" value="">
                                <input type="hidden" name="search_by" value="">
                                
                                <!-- Acciones masivas más espaciosas -->
                                <div class="card bg-light border mb-4">
                                    <div class="card-body">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-4">
                                                <label class="form-label">Acción para empleados seleccionados</label>
                                                <select name="accion" id="accion" class="form-select" required>
                                                    <option value="">-- Selecciona una acción --</option>
                                                    <optgroup label="Actualizar Campo">
                                                        <option value="area_id">Cambiar Área</option>
                                                        <option value="turno_id">Cambiar Turno</option>
                                                        <option value="status_id">Cambiar Status</option>
                                                        <option value="acreditacion_id">Cambiar Acreditación</option>
                                                        <option value="nomina_id">Cambiar Nómina</option>
                                                    </optgroup>
                                                    <optgroup label="Planificar Asistencia">
                                                        <option value="planificar-1">Asistencia Normal</option>
                                                        <option value="planificar-2">Vacaciones</option>
                                                        <option value="planificar-3">Licencia Médica</option>
                                                    </optgroup>
                                                    <optgroup label="Administrar">
                                                        <option value="eliminar" style="color:red; font-weight:bold;">ELIMINAR SELECCIONADOS</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-3" id="valor-container" style="display: none;">
                                                <label class="form-label">Nuevo valor</label>
                                                <select name="nuevo_valor_acreditacion_id" id="select_acreditacion_id" class="form-select value-select" style="display: none;">
                                                    <option value="1">Acreditación Básica</option>
                                                    <option value="2">Acreditación Avanzada</option>
                                                </select>
                                                <select name="nuevo_valor_nomina_id" id="select_nomina_id" class="form-select value-select" style="display: none;">
                                                    <option value="1">Nómina A</option>
                                                    <option value="2">Nómina B</option>
                                                </select>
                                                <select name="nuevo_valor_area_id" id="select_area_id" class="form-select value-select" style="display: none;">
                                                    <option value="1">Administración</option>
                                                    <option value="2">Producción</option>
                                                    <option value="3">Logística</option>
                                                </select> 
                                                <select name="nuevo_valor_turno_id" id="select_turno_id" class="form-select value-select" style="display: none;">
                                                    <option value="1">Mañana</option>
                                                    <option value="2">Tarde</option>
                                                    <option value="3">Noche</option>
                                                </select> 
                                                <select name="nuevo_valor_status_id" id="select_status_id" class="form-select value-select" style="display: none;">
                                                    <option value="1">Activo</option>
                                                    <option value="2">Inactivo</option>
                                                    <option value="3">Vacaciones</option>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-3" id="fecha-container" style="display: none;">
                                                <label class="form-label">Período</label>
                                                <div class="d-flex gap-2">
                                                    <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" placeholder="Desde">
                                                    <input type="date" name="fecha_fin" id="fecha_fin" class="form-control" placeholder="Hasta">
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-2">
                                                <button type="submit" class="btn btn-warning w-100">
                                                    <i class="fas fa-bolt me-2"></i>Aplicar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead>
                                            <tr>
                                                <th width="80">
                                                    <div class="form-check">
                                                        <input type="checkbox" id="select-all" class="form-check-input">
                                                    </div>
                                                </th>
                                                <th width="150">RUT</th>
                                                <th width="300">Nombre Completo</th>
                                                <th width="120">ID SAP</th>
                                                <th width="150">Teléfono</th>
                                                <th width="200">Cargo</th>
                                                <th width="200">Área</th>
                                                <th width="120">Status</th>
                                                <th width="150" class="text-end">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div class="form-check">
                                                        <input type="checkbox" name="empleado_ids" value="1" class="employee-checkbox form-check-input" id="checkbox-1">
                                                    </div>
                                                </td>
                                                
                                                <!-- RUT CLICKEABLE -->
                                                <td>
                                                    <span class="clickable-field" 
                                                          data-checkbox="checkbox-1" 
                                                          title="Clic para seleccionar empleado">
                                                        12345678-9
                                                    </span>
                                                </td>
                                                
                                                <td>Juan Pérez González</td>
                                                
                                                <!-- ID SAP CLICKEABLE -->
                                                <td>
                                                    <span class="badge bg-info-subtle text-info-emphasis clickable-field" 
                                                          data-checkbox="checkbox-1" 
                                                          title="Clic para seleccionar empleado">
                                                        EMP001
                                                    </span>
                                                </td>
                                                
                                                <td>+56 9 1234 5678</td>
                                                <td>Analista de Sistemas</td>
                                                <td>Tecnología</td>
                                                <td>
                                                    <span class="badge bg-success">Vigente</span>
                                                </td>
                                                <td class="text-end">
                                                    <div class="d-flex gap-2 justify-content-end">
                                                        <button type="button" class="btn btn-outline-primary btn-sm edit-employee-modal" title="Editar" data-employee-id="1">
                                                            <i class="fas fa-pencil-alt"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" title="Eliminar" 
                                                                onclick="return confirm('¿Estás seguro de que quieres eliminar a este empleado?');">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="form-check">
                                                        <input type="checkbox" name="empleado_ids" value="2" class="employee-checkbox form-check-input" id="checkbox-2">
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="clickable-field" 
                                                          data-checkbox="checkbox-2" 
                                                          title="Clic para seleccionar empleado">
                                                        98765432-1
                                                    </span>
                                                </td>
                                                <td>María González López</td>
                                                <td>
                                                    <span class="badge bg-info-subtle text-info-emphasis clickable-field" 
                                                          data-checkbox="checkbox-2" 
                                                          title="Clic para seleccionar empleado">
                                                        EMP002
                                                    </span>
                                                </td>
                                                <td>+56 9 8765 4321</td>
                                                <td>Gerente de Recursos Humanos</td>
                                                <td>Recursos Humanos</td>
                                                <td>
                                                    <span class="badge bg-success">Vigente</span>
                                                </td>
                                                <td class="text-end">
                                                    <div class="d-flex gap-2 justify-content-end">
                                                        <button type="button" class="btn btn-outline-primary btn-sm edit-employee-modal" title="Editar" data-employee-id="2">
                                                            <i class="fas fa-pencil-alt"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" title="Eliminar" 
                                                                onclick="return confirm('¿Estás seguro de que quieres eliminar a este empleado?');">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                            </form>
                        </div>
                    </div>
                </div>

                <!-- TAB DE REGISTRO DE EMPLEADO - VERSIÓN SIMPLIFICADA -->
                <div class="tab-pane fade p-4" id="registrar-pane" role="tabpanel" aria-labelledby="registrar-tab" tabindex="0">
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-user-plus fa-4x text-primary mb-3"></i>
                            <h3>Registro Avanzado de Empleados</h3>
                            <p class="text-muted">Utilice nuestro formulario avanzado para registrar nuevos empleados con validación en tiempo real</p>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg" id="new-employee-modal-btn">
                            <i class="fas fa-plus-circle me-2"></i>Abrir Formulario Avanzado
                        </button>
                    </div>
                </div>
                
                <div class="tab-pane fade p-4" id="herramientas-pane" role="tabpanel" aria-labelledby="herramientas-tab" tabindex="0">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <!-- Componente de Drag & Drop para carga masiva -->
                            <div class="upload-section">
                                <div class="card border-0 shadow-lg">
                                    <div class="card-header bg-gradient-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>Carga Masiva de Empleados
                                        </h5>
                                    </div>
                                    <div class="card-body p-4">
                                        
                                        <!-- Área de Drag & Drop -->
                                        <div class="dropzone-container">
                                            <div class="dropzone" id="file-dropzone">
                                                <div class="dropzone-content" id="dropzone-content">
                                                    <div class="upload-icon">
                                                        <i class="fas fa-cloud-upload-alt"></i>
                                                    </div>
                                                    <h4 class="upload-title">Arrastra tu archivo aquí</h4>
                                                    <p class="upload-description">
                                                        o <button type="button" class="btn-link" id="browse-files">haz clic para seleccionar</button>
                                                    </p>
                                                    <div class="upload-info">
                                                        <small class="text-muted">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Formatos soportados: Excel (.xlsx, .xls), CSV (.csv) - Máximo 10MB
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                <!-- Preview del archivo seleccionado -->
                                                <div class="file-preview d-none" id="file-preview">
                                                    <div class="file-info">
                                                        <div class="file-icon">
                                                            <i class="fas fa-file-excel text-success"></i>
                                                        </div>
                                                        <div class="file-details">
                                                            <h6 class="file-name" id="file-name">archivo.xlsx</h6>
                                                            <p class="file-size text-muted" id="file-size">0 KB</p>
                                                            <div class="file-progress">
                                                                <div class="progress">
                                                                    <div class="progress-bar bg-success" id="upload-progress" style="width: 0%"></div>
                                                                </div>
                                                                <small class="progress-text" id="progress-text">Listo para subir</small>
                                                            </div>
                                                        </div>
                                                        <div class="file-actions">
                                                            <button type="button" class="btn btn-success btn-sm" id="upload-btn">
                                                                <i class="fas fa-upload me-1"></i>Subir
                                                            </button>
                                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="remove-file">
                                                                <i class="fas fa-trash me-1"></i>Quitar
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Input file oculto -->
                                        <input type="file" 
                                               id="file-input" 
                                               accept=".xlsx,.xls,.csv" 
                                               style="display: none;"
                                               name="archivo_excel">
                                        
                                        <!-- Opciones de carga -->
                                        <div class="upload-options mt-4" id="upload-options">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="validate-data" checked>
                                                        <label class="form-check-label" for="validate-data">
                                                            <i class="fas fa-check-circle text-success me-1"></i>
                                                            Validar datos antes de importar
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="skip-duplicates" checked>
                                                        <label class="form-check-label" for="skip-duplicates">
                                                            <i class="fas fa-filter text-info me-1"></i>
                                                            Saltar duplicados automáticamente
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="send-notifications">
                                                        <label class="form-check-label" for="send-notifications">
                                                            <i class="fas fa-bell text-warning me-1"></i>
                                                            Notificar por email al completar
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="create-backup" checked>
                                                        <label class="form-check-label" for="create-backup">
                                                            <i class="fas fa-save text-primary me-1"></i>
                                                            Crear respaldo antes de importar
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Plantilla descargable -->
                                        <div class="template-section mt-4">
                                            <div class="alert alert-info d-flex align-items-center" role="alert">
                                                <i class="fas fa-download text-info me-3" style="font-size: 1.5rem;"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="alert-heading mb-1">¿Primera vez usando carga masiva?</h6>
                                                    <p class="mb-2">Descarga nuestra plantilla con las columnas correctas y ejemplos.</p>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-info btn-sm" id="download-template">
                                                            <i class="fas fa-file-excel me-1"></i>Descargar Plantilla Excel
                                                        </button>
                                                        <button type="button" class="btn btn-outline-info btn-sm" id="view-instructions">
                                                            <i class="fas fa-question-circle me-1"></i>Ver Instrucciones
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Resultados de carga -->
                                        <div class="upload-results d-none" id="upload-results">
                                            <div class="alert alert-success">
                                                <h6 class="alert-heading">
                                                    <i class="fas fa-check-circle me-2"></i>Carga Completada
                                                </h6>
                                                <div class="results-summary" id="results-summary">
                                                    <!-- Se llenará dinámicamente -->
                                                </div>
                                                <hr>
                                                <div class="results-actions">
                                                    <button type="button" class="btn btn-success btn-sm" id="view-imported">
                                                        <i class="fas fa-eye me-1"></i>Ver Empleados Importados
                                                    </button>
                                                    <button type="button" class="btn btn-outline-success btn-sm" id="download-report">
                                                        <i class="fas fa-download me-1"></i>Descargar Reporte
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Errores de validación -->
                                        <div class="validation-errors d-none" id="validation-errors">
                                            <div class="alert alert-warning">
                                                <h6 class="alert-heading">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>Se encontraron errores de validación
                                                </h6>
                                                <div class="errors-list" id="errors-list">
                                                    <!-- Se llenará dinámicamente -->
                                                </div>
                                                <hr>
                                                <div class="error-actions">
                                                    <button type="button" class="btn btn-warning btn-sm" id="download-errors">
                                                        <i class="fas fa-file-excel me-1"></i>Descargar Errores
                                                    </button>
                                                    <button type="button" class="btn btn-outline-warning btn-sm" id="fix-and-retry">
                                                        <i class="fas fa-redo me-1"></i>Corregir y Reintentar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 border-danger-subtle">
                                <div class="card-body">
                                    <h5 class="card-title text-danger"><i class="fas fa-user-slash me-2"></i>Actualización de Desvinculaciones</h5>
                                    <p class="card-text text-muted">Sube un Excel con rut, id_sap_local, fecha_egreso y causal_despido_id para procesar finiquitos.</p>
                                    <form action="#" method="post" enctype="multipart/form-data">
                                        <div class="input-group"><input type="file" class="form-control" name="archivo_excel" accept=".xlsx" required><button type="submit" class="btn btn-danger"><i class="fas fa-arrow-right-from-bracket me-2"></i>Procesar</button></div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card h-100 mt-4 border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary"><i class="fas fa-file-import me-2"></i>Importación Inteligente</h5>
                                    <p class="card-text text-muted">Validación en tiempo real con vista previa y corrección automática de datos.</p>
                                    <button type="button" class="btn btn-primary mt-2" id="open-import-modal">
                                        <i class="fas fa-play-circle me-2"></i>Abrir Importador Inteligente
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modal de Instrucciones -->
    <div class="modal fade" id="instructionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-book me-2"></i>Instrucciones de Carga Masiva
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="instruction-step">
                        <h6><i class="fas fa-download text-success me-2"></i>Paso 1: Descarga la Plantilla</h6>
                        <p>Descarga la plantilla Excel que contiene todas las columnas necesarias con ejemplos.</p>
                    </div>
                    
                    <div class="instruction-step">
                        <h6><i class="fas fa-edit text-info me-2"></i>Paso 2: Completa los Datos</h6>
                        <p>Llena la plantilla con los datos de tus empleados. Columnas obligatorias:</p>
                        <ul class="list-unstyled ps-4">
                            <li><i class="fas fa-check text-success me-2"></i>RUT (formato: 12345678-9)</li>
                            <li><i class="fas fa-check text-success me-2"></i>Nombre Completo</li>
                            <li><i class="fas fa-check text-success me-2"></i>Fecha de Ingreso (formato: DD/MM/AAAA)</li>
                            <li><i class="fas fa-check text-success me-2"></i>Cargo</li>
                        </ul>
                    </div>
                    
                    <div class="instruction-step">
                        <h6><i class="fas fa-upload text-warning me-2"></i>Paso 3: Sube el Archivo</h6>
                        <p>Arrastra tu archivo completado al área de carga o haz clic para seleccionarlo.</p>
                    </div>
                    
                    <div class="instruction-step">
                        <h6><i class="fas fa-cogs text-primary me-2"></i>Paso 4: Configura las Opciones</h6>
                        <p>Selecciona las opciones de validación y procesamiento según tus necesidades.</p>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h6 class="alert-heading">Consejos Importantes:</h6>
                        <ul class="mb-0">
                            <li>Asegúrate de que los RUTs estén en formato chileno válido</li>
                            <li>Las fechas deben estar en formato DD/MM/AAAA</li>
                            <li>Los cargos, áreas y turnos deben existir previamente en el sistema</li>
                            <li>Revisa que no haya espacios extra en los datos</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" id="download-template-modal">
                        <i class="fas fa-download me-1"></i>Descargar Plantilla
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Principal para Agregar/Editar Empleado -->
    <div class="modal fade" id="employeeModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <!-- Header del Modal -->
                <div class="modal-header bg-gradient-primary text-white">
                    <div class="modal-title-container">
                        <h4 class="modal-title" id="employeeModalTitle">
                            <i class="fas fa-user-plus me-2"></i>Agregar Nuevo Empleado
                        </h4>
                        <p class="modal-subtitle mb-0" id="employeeModalSubtitle">
                            Complete toda la información requerida del empleado
                        </p>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline-light btn-sm" id="modal-help-btn">
                            <i class="fas fa-question-circle"></i>
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="modal-progress">
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-success" id="form-progress" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Body del Modal -->
                <div class="modal-body">
                    <!-- Navegación por pasos -->
                    <div class="step-navigation">
                        <div class="steps-container">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">Información Personal</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">Información Laboral</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-label">Asignaciones</div>
                            </div>
                            <div class="step" data-step="4">
                                <div class="step-number">4</div>
                                <div class="step-label">Revisión</div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario Multi-Step -->
                    <form id="employeeForm" class="multi-step-form">
                        <!-- Paso 1: Información Personal -->
                        <div class="step-content active" data-step="1">
                            <div class="step-header">
                                <h5><i class="fas fa-user me-2 text-primary"></i>Información Personal</h5>
                                <p class="text-muted">Datos básicos y personales del empleado</p>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label required">RUT</label>
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control" 
                                               name="rut" 
                                               id="rut"
                                               placeholder="12345678-9" 
                                               data-validation="rut">
                                        <button type="button" class="btn btn-outline-secondary" id="validate-rut">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label required">Nombre Completo</label>
                                    <input type="text" 
                                           class="form-control" 
                                           name="nombre_completo" 
                                           id="nombre_completo"
                                           placeholder="Nombres y Apellidos"
                                           data-validation="required">
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" 
                                           class="form-control" 
                                           name="fecha_nacimiento" 
                                           id="fecha_nacimiento"
                                           data-validation="date">
                                    <div class="form-feedback"></div>
                                    <small class="age-display text-muted"></small>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Teléfono</label>
                                    <input type="tel" 
                                           class="form-control" 
                                           name="telefono" 
                                           id="telefono"
                                           placeholder="+56 9 1234 5678"
                                           data-validation="phone">
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Email</label>
                                    <input type="email" 
                                           class="form-control" 
                                           name="email" 
                                           id="email"
                                           placeholder="empleado@empresa.com"
                                           data-validation="email">
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-8">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" 
                                           class="form-control" 
                                           name="direccion" 
                                           id="direccion"
                                           placeholder="Dirección completa">
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label required">Región</label>
                                    <select class="form-select" 
                                            name="region_id" 
                                            id="region_id"
                                            data-validation="required">
                                        <option value="">-- Seleccione Región --</option>
                                        <option value="1">Región Metropolitana</option>
                                        <option value="2">Región de Valparaíso</option>
                                        <option value="3">Región del Biobío</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label required">Comuna</label>
                                    <select class="form-select" 
                                            name="comuna_id" 
                                            id="comuna_id"
                                            data-validation="required" 
                                            disabled>
                                        <option value="">-- Primero elija una región --</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Paso 2: Información Laboral -->
                        <div class="step-content" data-step="2">
                            <div class="step-header">
                                <h5><i class="fas fa-briefcase me-2 text-success"></i>Información Laboral</h5>
                                <p class="text-muted">Detalles contractuales y laborales</p>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">ID SAP Local</label>
                                    <input type="text" 
                                           class="form-control" 
                                           name="id_sap_local" 
                                           id="id_sap_local"
                                           placeholder="EMP001">
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">ID SAP Global</label>
                                    <input type="text" 
                                           class="form-control" 
                                           name="id_sap_global" 
                                           id="id_sap_global"
                                           placeholder="GLB001">
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label required">Fecha de Ingreso</label>
                                    <input type="date" 
                                           class="form-control" 
                                           name="fecha_ingreso" 
                                           id="fecha_ingreso"
                                           data-validation="required">
                                    <div class="form-feedback"></div>
                                    <small class="tenure-display text-muted"></small>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label required">Tipo de Contrato</label>
                                    <select class="form-select" 
                                            name="tipo_contrato_id" 
                                            id="tipo_contrato_id"
                                            data-validation="required">
                                        <option value="">-- Seleccione Tipo --</option>
                                        <option value="1">Indefinido</option>
                                        <option value="2">Plazo Fijo</option>
                                        <option value="3">Por Obra o Faena</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-6" id="campo-vencimiento" style="display: none;">
                                    <label class="form-label">Fecha Vencimiento</label>
                                    <input type="date" 
                                           class="form-control" 
                                           name="fecha_vencimiento_contrato" 
                                           id="fecha_vencimiento_contrato">
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-12">
                                    <div class="contract-preview alert alert-info d-none" id="contract-preview">
                                        <h6><i class="fas fa-file-contract me-2"></i>Vista Previa del Contrato</h6>
                                        <div class="contract-details"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Paso 3: Asignaciones -->
                        <div class="step-content" data-step="3">
                            <div class="step-header">
                                <h5><i class="fas fa-sitemap me-2 text-warning"></i>Asignaciones Organizacionales</h5>
                                <p class="text-muted">Cargo, área, turno y otras asignaciones</p>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label required">Cargo</label>
                                    <select class="form-select" 
                                            name="cargo_id" 
                                            id="cargo_id"
                                            data-validation="required">
                                        <option value="">-- Seleccione Cargo --</option>
                                        <option value="1">Analista de Sistemas</option>
                                        <option value="2">Gerente de Recursos Humanos</option>
                                        <option value="3">Desarrollador</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                    <div class="cargo-info mt-2 d-none"></div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Área</label>
                                    <select class="form-select" name="area_id" id="area_id">
                                        <option value="">-- Seleccione Área --</option>
                                        <option value="1">Tecnología</option>
                                        <option value="2">Recursos Humanos</option>
                                        <option value="3">Operaciones</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label required">Turno</label>
                                    <select class="form-select" 
                                            name="turno_id" 
                                            id="turno_id"
                                            data-validation="required">
                                        <option value="">-- Seleccione Turno --</option>
                                        <option value="1">Mañana</option>
                                        <option value="2">Tarde</option>
                                        <option value="3">Noche</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                    <div class="turno-info mt-2 d-none"></div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Supervisión</label>
                                    <select class="form-select" name="supervision_id" id="supervision_id">
                                        <option value="">-- Seleccione Supervisión --</option>
                                        <option value="1">Supervisión Norte</option>
                                        <option value="2">Supervisión Sur</option>
                                        <option value="3">Supervisión Centro</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Fase</label>
                                    <select class="form-select" name="fase_id" id="fase_id">
                                        <option value="">-- Seleccione Fase --</option>
                                        <option value="1">Fase 1</option>
                                        <option value="2">Fase 2</option>
                                        <option value="3">Fase 3</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Relación Laboral</label>
                                    <select class="form-select" name="relacion_laboral_id" id="relacion_laboral_id">
                                        <option value="">-- Seleccione --</option>
                                        <option value="1">Contratista</option>
                                        <option value="2">Planta</option>
                                        <option value="3">Honorarios</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status_id" id="status_id">
                                        <option value="">-- Seleccione Status --</option>
                                        <option value="1">Activo</option>
                                        <option value="2">Inactivo</option>
                                        <option value="3">Vacaciones</option>
                                    </select>
                                    <div class="form-feedback"></div>
                                </div>
                            </div>
                            
                            <!-- Vista previa de la estructura organizacional -->
                            <div class="org-preview mt-4">
                                <h6><i class="fas fa-chart-line me-2"></i>Vista Previa Organizacional</h6>
                                <div class="org-chart" id="org-chart">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Paso 4: Revisión -->
                        <div class="step-content" data-step="4">
                            <div class="step-header">
                                <h5><i class="fas fa-check-circle me-2 text-info"></i>Revisión Final</h5>
                                <p class="text-muted">Verifique toda la información antes de guardar</p>
                            </div>
                            
                            <div class="review-section">
                                <div class="review-cards">
                                    <!-- Tarjetas de revisión generadas dinámicamente -->
                                </div>
                                
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="confirm-data">
                                    <label class="form-check-label" for="confirm-data">
                                        <strong>Confirmo que toda la información es correcta</strong>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer del Modal -->
                <div class="modal-footer">
                    <div class="footer-content">
                        <div class="validation-summary" id="validation-summary">
                            <!-- Resumen de validación -->
                        </div>
                        
                        <div class="modal-buttons">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="prev-step" style="display: none;">
                                <i class="fas fa-chevron-left me-1"></i>Anterior
                            </button>
                            <button type="button" class="btn btn-primary" id="next-step">
                                Siguiente<i class="fas fa-chevron-right ms-1"></i>
                            </button>
                            <button type="submit" class="btn btn-success" id="submit-form" style="display: none;">
                                <i class="fas fa-save me-1"></i>Guardar Empleado
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Acción
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="confirm-content">
                        <p id="confirm-message">¿Está seguro que desea realizar esta acción?</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirm-action">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Estados de Carga -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body text-center p-5">
                    <div class="loading-animation mb-4">
                        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
                    </div>
                    <h4 class="loading-title" id="loading-title">Procesando...</h4>
                    <p class="loading-message text-muted" id="loading-message">Por favor espere mientras procesamos su solicitud</p>
                    
                    <!-- Progress Bar Detallada -->
                    <div class="progress-section mt-4">
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                 id="detailed-progress" style="width: 0%"></div>
                        </div>
                        <div class="progress-steps">
                            <small class="text-muted" id="current-step">Iniciando proceso...</small>
                        </div>
                    </div>
                    
                    <!-- Estado de conexión -->
                    <div class="connection-status mt-3">
                        <small class="text-success">
                            <i class="fas fa-wifi me-1"></i>Conectado al servidor
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Importación Avanzada -->
    <div class="modal fade" id="realTimeImportModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-gradient-import text-white">
                    <div class="import-header-info">
                        <h4 class="modal-title">
                            <i class="fas fa-file-import me-2"></i>Importación Inteligente
                        </h4>
                        <p class="mb-0">Validación en tiempo real con vista previa y corrección automática</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <!-- Progress Steps -->
                <div class="import-progress-steps">
                    <div class="step-indicator">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-title">Seleccionar Archivo</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-title">Validar Datos</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-title">Corregir Errores</div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-title">Importar</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-body">
                    <!-- Paso 1: Selección de Archivo -->
                    <div class="import-step active" data-step="1">
                        <div class="file-upload-advanced">
                            <div class="upload-options mb-4">
                                <h6><i class="fas fa-cog me-2"></i>Configuración de Importación</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Modo de Validación</label>
                                        <select class="form-select" id="validation-mode">
                                            <option value="strict">Estricto (Rechazar errores)</option>
                                            <option value="permissive" selected>Permisivo (Corregir automáticamente)</option>
                                            <option value="interactive">Interactivo (Preguntar por cada error)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Manejo de Duplicados</label>
                                        <select class="form-select" id="duplicate-handling">
                                            <option value="skip">Saltar duplicados</option>
                                            <option value="update" selected>Actualizar existentes</option>
                                            <option value="create">Crear como nuevos</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Procesamiento</label>
                                        <select class="form-select" id="processing-mode">
                                            <option value="batch" selected>Por lotes (Rápido)</option>
                                            <option value="real-time">Tiempo real (Detallado)</option>
                                            <option value="background">En segundo plano</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="drag-drop-zone" id="advanced-dropzone">
                                <div class="drop-content">
                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                    <h5>Arrastra tu archivo Excel o CSV</h5>
                                    <p class="text-muted">o <button type="button" class="btn-link" id="browse-advanced">selecciona desde tu computador</button></p>
                                    <div class="supported-formats">
                                        <small class="text-muted">
                                            <i class="fas fa-check text-success me-1"></i>Excel (.xlsx, .xls)
                                            <i class="fas fa-check text-success me-1 ms-3"></i>CSV (.csv)
                                            <i class="fas fa-check text-success me-1 ms-3"></i>Hasta 100MB
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <input type="file" id="advanced-file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                        </div>
                    </div>
                    
                    <!-- Paso 2: Validación en Tiempo Real -->
                    <div class="import-step" data-step="2">
                        <div class="validation-progress">
                            <div class="progress-header">
                                <h6><i class="fas fa-cogs me-2"></i>Validando Datos en Tiempo Real</h6>
                                <div class="validation-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-file-alt text-primary"></i>
                                        <span id="total-rows">0</span> filas
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-check text-success"></i>
                                        <span id="valid-rows">0</span> válidas
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        <span id="warning-rows">0</span> advertencias
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-times text-danger"></i>
                                        <span id="error-rows">0</span> errores
                                    </span>
                                </div>
                            </div>
                            
                            <div class="progress mb-3">
                                <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                     id="validation-progress" style="width: 0%"></div>
                            </div>
                            
                            <div class="validation-details">
                                <div class="validation-log" id="validation-log">
                                    <!-- Log de validación en tiempo real -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de Vista Previa -->
                        <div class="data-preview mt-4">
                            <h6><i class="fas fa-table me-2"></i>Vista Previa de Datos</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="preview-table">
                                    <thead class="table-dark">
                                        <!-- Se genera dinámicamente -->
                                    </thead>
                                    <tbody>
                                        <!-- Se genera dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paso 3: Corrección de Errores -->
                    <div class="import-step" data-step="3">
                        <div class="error-correction">
                            <div class="correction-header">
                                <h6><i class="fas fa-wrench me-2"></i>Corregir Errores Encontrados</h6>
                                <div class="correction-actions">
                                    <button class="btn btn-success btn-sm" id="auto-fix-all">
                                        <i class="fas fa-magic me-1"></i>Corrección Automática
                                    </button>
                                    <button class="btn btn-warning btn-sm" id="skip-errors">
                                        <i class="fas fa-forward me-1"></i>Saltar Errores
                                    </button>
                                    <button class="btn btn-info btn-sm" id="export-errors">
                                        <i class="fas fa-download me-1"></i>Exportar Errores
                                    </button>
                                </div>
                            </div>
                            
                            <div class="errors-container" id="errors-container">
                                <!-- Lista de errores editables -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paso 4: Importación Final -->
                    <div class="import-step" data-step="4">
                        <div class="final-import">
                            <div class="import-summary">
                                <h6><i class="fas fa-clipboard-check me-2"></i>Resumen de Importación</h6>
                                
                                <div class="summary-cards">
                                    <div class="summary-card success">
                                        <div class="card-icon">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="card-info">
                                            <div class="card-number" id="final-valid">0</div>
                                            <div class="card-label">Registros Válidos</div>
                                        </div>
                                    </div>
                                    
                                    <div class="summary-card warning">
                                        <div class="card-icon">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="card-info">
                                            <div class="card-number" id="final-warnings">0</div>
                                            <div class="card-label">Advertencias</div>
                                        </div>
                                    </div>
                                    
                                    <div class="summary-card danger">
                                        <div class="card-icon">
                                            <i class="fas fa-times-circle"></i>
                                        </div>
                                        <div class="card-info">
                                            <div class="card-number" id="final-errors">0</div>
                                            <div class="card-label">Errores</div>
                                        </div>
                                    </div>
                                    
                                    <div class="summary-card info">
                                        <div class="card-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="card-info">
                                            <div class="card-number" id="processing-time">0s</div>
                                            <div class="card-label">Tiempo</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="final-options mt-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="send-notification" checked>
                                        <label class="form-check-label" for="send-notification">
                                            Enviar notificación por email al completar
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="create-backup" checked>
                                        <label class="form-check-label" for="create-backup">
                                            Crear respaldo antes de importar
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="generate-report" checked>
                                        <label class="form-check-label" for="generate-report">
                                            Generar reporte detallado de importación
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <div class="footer-left">
                        <div class="import-status" id="import-status">
                            Listo para comenzar
                        </div>
                    </div>
                    
                    <div class="footer-right">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="prev-import-step" style="display: none;">
                            <i class="fas fa-arrow-left me-1"></i>Anterior
                        </button>
                        <button type="button" class="btn btn-primary" id="next-import-step">
                            Siguiente<i class="fas fa-arrow-right ms-1"></i>
                        </button>
                        <button type="button" class="btn btn-success" id="start-import" style="display: none;">
                            <i class="fas fa-play me-1"></i>Iniciar Importación
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Progreso de Importación -->
    <div class="modal fade" id="importProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="import-animation mb-4">
                        <div class="spinner-container">
                            <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
                            <div class="spinner-inner">
                                <i class="fas fa-database text-primary"></i>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="import-title" id="import-progress-title">Importando Datos...</h4>
                    <p class="import-message text-muted" id="import-progress-message">
                        Por favor espere mientras procesamos los datos
                    </p>
                    
                    <div class="progress-detailed mb-3">
                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar bg-gradient-success progress-bar-striped progress-bar-animated" 
                                 id="import-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="progress-info">
                            <small class="text-muted">
                                <span id="current-record">0</span> de <span id="total-records">0</span> registros procesados
                            </small>
                        </div>
                    </div>
                    
                    <div class="live-updates" id="live-updates">
                        <div class="update-line">Iniciando proceso...</div>
                    </div>
                    
                    <button class="btn btn-outline-danger btn-sm mt-3" id="cancel-import" style="display: none;">
                        <i class="fas fa-stop me-1"></i>Cancelar Importación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    /* ===================================================================== */
    /* JAVASCRIPT UNIFICADO PARA EL SISTEMA DE GESTIÓN DE EMPLEADOS         */
    /* ===================================================================== */
    
    // Theme Toggle
    function toggleTheme() {
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');
        const currentTheme = body.getAttribute('data-bs-theme');
        
        if (currentTheme === 'light') {
            body.setAttribute('data-bs-theme', 'dark');
            themeIcon.className = 'fas fa-sun';
            localStorage.setItem('theme', 'dark');
        } else {
            body.setAttribute('data-bs-theme', 'light');
            themeIcon.className = 'fas fa-moon';
            localStorage.setItem('theme', 'light');
        }
    }

    // Función para mostrar toast notifications
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        const icons = {
            success: 'fas fa-check-circle',
            error: 'fas fa-times-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };
        
        toast.innerHTML = `
            <div class="toast-content">
                <i class="${icons[type]}"></i>
                <span>${message}</span>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            <div class="toast-progress"></div>
        `;
        
        container.appendChild(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }
        }, 4000);
    }

    // Cargar tema al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-bs-theme', savedTheme);
        document.getElementById('theme-icon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        // Hacer la función disponible globalmente
        window.showToast = showToast;
    });

    /* ===================================================================== */
    /* JAVASCRIPT PARA DRAG & DROP AVANZADO                                 */
    /* ===================================================================== */

    class AdvancedFileUploader {
        constructor() {
            this.selectedFile = null;
            this.uploadInProgress = false;
            
            this.initElements();
            this.bindEvents();
        }
        
        initElements() {
            this.dropzone = document.getElementById('file-dropzone');
            this.fileInput = document.getElementById('file-input');
            this.browseBtn = document.getElementById('browse-files');
            this.dropzoneContent = document.getElementById('dropzone-content');
            this.filePreview = document.getElementById('file-preview');
            this.fileName = document.getElementById('file-name');
            this.fileSize = document.getElementById('file-size');
            this.uploadBtn = document.getElementById('upload-btn');
            this.removeFileBtn = document.getElementById('remove-file');
            this.uploadProgress = document.getElementById('upload-progress');
            this.progressText = document.getElementById('progress-text');
            this.uploadResults = document.getElementById('upload-results');
            this.validationErrors = document.getElementById('validation-errors');
            this.downloadTemplateBtn = document.getElementById('download-template');
            this.viewInstructionsBtn = document.getElementById('view-instructions');
        }
        
        bindEvents() {
            // Drag & Drop events
            this.dropzone.addEventListener('dragenter', this.handleDragEnter.bind(this));
            this.dropzone.addEventListener('dragover', this.handleDragOver.bind(this));
            this.dropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));
            this.dropzone.addEventListener('drop', this.handleDrop.bind(this));
            
            // File input events
            this.browseBtn.addEventListener('click', () => this.fileInput.click());
            this.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
            
            // Upload controls
            this.uploadBtn.addEventListener('click', this.uploadFile.bind(this));
            this.removeFileBtn.addEventListener('click', this.removeFile.bind(this));
            
            // Template and instructions
            this.downloadTemplateBtn.addEventListener('click', this.downloadTemplate.bind(this));
            this.viewInstructionsBtn.addEventListener('click', this.showInstructions.bind(this));
            
            // Modal template download
            const modalTemplateBtn = document.getElementById('download-template-modal');
            if (modalTemplateBtn) {
                modalTemplateBtn.addEventListener('click', this.downloadTemplate.bind(this));
            }
            
            // Prevent default drag behaviors on the whole document
            document.addEventListener('dragenter', e => e.preventDefault());
            document.addEventListener('dragover', e => e.preventDefault());
            document.addEventListener('drop', e => e.preventDefault());
        }
        
        handleDragEnter(e) {
            e.preventDefault();
            e.stopPropagation();
            this.dropzone.classList.add('drag-over');
        }
        
        handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Only remove drag-over if we're leaving the dropzone entirely
            if (!this.dropzone.contains(e.relatedTarget)) {
                this.dropzone.classList.remove('drag-over');
            }
        }
        
        handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            this.dropzone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        }
        
        handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        }
        
        handleFile(file) {
            // Validar tipo de archivo
            const allowedTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                'application/vnd.ms-excel', // .xls
                'text/csv' // .csv
            ];
            
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                this.showError('Tipo de archivo no válido. Solo se permiten archivos Excel (.xlsx, .xls) o CSV (.csv)');
                return;
            }
            
            // Validar tamaño (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                this.showError('El archivo es demasiado grande. El tamaño máximo es 10MB.');
                return;
            }
            
            this.selectedFile = file;
            this.showFilePreview();
        }
        
        showFilePreview() {
            // Ocultar contenido de dropzone y mostrar preview
            this.dropzoneContent.classList.add('d-none');
            this.filePreview.classList.remove('d-none');
            
            // Actualizar información del archivo
            this.fileName.textContent = this.selectedFile.name;
            this.fileSize.textContent = this.formatFileSize(this.selectedFile.size);
            
            // Actualizar icono según tipo
            const fileIcon = this.filePreview.querySelector('.file-icon i');
            if (this.selectedFile.name.match(/\.(xlsx|xls)$/i)) {
                fileIcon.className = 'fas fa-file-excel text-success';
            } else if (this.selectedFile.name.match(/\.csv$/i)) {
                fileIcon.className = 'fas fa-file-csv text-info';
            }
            
            // Reset progress
            this.uploadProgress.style.width = '0%';
            this.progressText.textContent = 'Listo para subir';
            
            // Cambiar estado del dropzone
            this.dropzone.classList.remove('error', 'success');
        }
        
        removeFile() {
            this.selectedFile = null;
            this.filePreview.classList.add('d-none');
            this.dropzoneContent.classList.remove('d-none');
            this.fileInput.value = '';
            
            // Reset estados
            this.dropzone.classList.remove('error', 'success', 'uploading');
            this.hideResults();
        }
        
        async uploadFile() {
            if (!this.selectedFile || this.uploadInProgress) return;
            
            this.uploadInProgress = true;
            this.dropzone.classList.add('uploading');
            this.uploadBtn.disabled = true;
            this.removeFileBtn.disabled = true;
            
            // Obtener opciones
            const options = {
                validate_data: document.getElementById('validate-data').checked,
                skip_duplicates: document.getElementById('skip-duplicates').checked,
                send_notifications: document.getElementById('send-notifications').checked,
                create_backup: document.getElementById('create-backup').checked
            };
            
            // Crear FormData
            const formData = new FormData();
            formData.append('archivo_excel', this.selectedFile);
            Object.entries(options).forEach(([key, value]) => {
                formData.append(key, value);
            });
            
            try {
                // Simular progreso (ya que XMLHttpRequest permite tracking real de progress)
                this.simulateProgress();
                
                const response = await this.uploadWithProgress(formData);
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    this.handleUploadSuccess(result);
                } else {
                    this.handleUploadError(result);
                }
                
            } catch (error) {
                console.error('Error en carga:', error);
                this.handleUploadError({ message: 'Error de conexión. Intenta nuevamente.' });
            } finally {
                this.uploadInProgress = false;
                this.dropzone.classList.remove('uploading');
                this.uploadBtn.disabled = false;
                this.removeFileBtn.disabled = false;
            }
        }
        
        uploadWithProgress(formData) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        this.updateProgress(percentComplete, 'Subiendo archivo...');
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve({
                            ok: true,
                            json: () => Promise.resolve(JSON.parse(xhr.responseText))
                        });
                    } else {
                        reject(new Error(`HTTP ${xhr.status}`));
                    }
                });
                
                xhr.addEventListener('error', () => reject(new Error('Network Error')));
                
                xhr.open('POST', '/upload_empleados');
                xhr.send(formData);
            });
        }
        
        simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 95) {
                    clearInterval(interval);
                    this.updateProgress(95, 'Procesando datos...');
                    return;
                }
                this.updateProgress(progress, 'Subiendo archivo...');
            }, 200);
        }
        
        updateProgress(percent, text) {
            this.uploadProgress.style.width = `${percent}%`;
            this.progressText.textContent = text;
        }
        
        handleUploadSuccess(result) {
            this.dropzone.classList.add('success');
            this.updateProgress(100, 'Completado con éxito');
            
            // Mostrar resultados
            this.showUploadResults(result);
            
            // Animación de éxito
            setTimeout(() => {
                this.dropzone.classList.add('upload-success');
                setTimeout(() => {
                    this.dropzone.classList.remove('upload-success');
                }, 600);
            }, 500);
        }
        
        handleUploadError(result) {
            this.dropzone.classList.add('error');
            this.updateProgress(0, 'Error en la carga');
            
            if (result.validation_errors && result.validation_errors.length > 0) {
                this.showValidationErrors(result.validation_errors);
            } else {
                this.showError(result.message || 'Error desconocido en la carga');
            }
        }
        
        showUploadResults(result) {
            const summary = document.getElementById('results-summary');
            summary.innerHTML = `
                <div class="result-stat">
                    <div class="result-number text-success">${result.imported || 0}</div>
                    <div class="result-label">Importados</div>
                </div>
                <div class="result-stat">
                    <div class="result-number text-warning">${result.skipped || 0}</div>
                    <div class="result-label">Omitidos</div>
                </div>
                <div class="result-stat">
                    <div class="result-number text-danger">${result.errors || 0}</div>
                    <div class="result-label">Errores</div>
                </div>
                <div class="result-stat">
                    <div class="result-number text-info">${result.total_processed || 0}</div>
                    <div class="result-label">Total Procesados</div>
                </div>
            `;
            
            this.uploadResults.classList.remove('d-none');
            
            // Bind result actions
            document.getElementById('view-imported')?.addEventListener('click', () => {
                // Redirigir a la lista de empleados con filtro de recién importados
                window.location.href = '/gestionar_empleados#empleados-registrados';
            });
            
            document.getElementById('download-report')?.addEventListener('click', () => {
                if (result.report_url) {
                    window.open(result.report_url, '_blank');
                }
            });
        }
        
        showValidationErrors(errors) {
            const errorsList = document.getElementById('errors-list');
            errorsList.innerHTML = `
                <p><strong>${errors.length}</strong> errores encontrados en el archivo:</p>
                <div class="list-group">
                    ${errors.slice(0, 10).map((error, index) => `
                        <div class="list-group-item">
                            <strong>Fila ${error.row}:</strong> ${error.message}
                            ${error.field ? `<br><small class="text-muted">Campo: ${error.field}</small>` : ''}
                        </div>
                    `).join('')}
                    ${errors.length > 10 ? `
                        <div class="list-group-item text-muted">
                            ... y ${errors.length - 10} errores más
                        </div>
                    ` : ''}
                </div>
            `;
            
            this.validationErrors.classList.remove('d-none');
            
            // Bind error actions
            document.getElementById('download-errors')?.addEventListener('click', () => {
                this.downloadErrorReport(errors);
            });
            
            document.getElementById('fix-and-retry')?.addEventListener('click', () => {
                this.removeFile();
            });
        }
        
        downloadErrorReport(errors) {
            // Crear CSV con errores
            const csv = [
                ['Fila', 'Campo', 'Error'],
                ...errors.map(error => [error.row, error.field || '', error.message])
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            // Crear blob y descargar
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `errores_importacion_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        showError(message) {
            this.dropzone.classList.add('error');
            this.progressText.textContent = message;
            
            // Mostrar notificación toast
            showToast(message, 'error');
        }
        
        hideResults() {
            this.uploadResults.classList.add('d-none');
            this.validationErrors.classList.add('d-none');
        }
        
        downloadTemplate() {
            // Crear un enlace para descargar la plantilla
            const a = document.createElement('a');
            a.href = '/plantillas/plantilla_empleados.xlsx';
            a.download = 'plantilla_empleados.xlsx';
            a.click();
        }
        
        showInstructions() {
            const modal = new bootstrap.Modal(document.getElementById('instructionsModal'));
            modal.show();
        }
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    }

    /* ===================================================================== */
    /* JAVASCRIPT PARA SISTEMA DE MODALES AVANZADOS                         */
    /* ===================================================================== */

    class EmployeeModalSystem {
        constructor() {
            this.currentStep = 1;
            this.totalSteps = 4;
            this.formData = {};
            this.initModal();
            this.bindEvents();
        }
        
        initModal() {
            this.modal = new bootstrap.Modal(document.getElementById('employeeModal'));
            this.modalElement = document.getElementById('employeeModal');
            this.form = document.getElementById('employeeForm');
        }
        
        bindEvents() {
            // Botón para abrir modal
            document.getElementById('new-employee-modal-btn')?.addEventListener('click', () => {
                this.openModal();
            });
            
            // Navegación entre pasos
            document.getElementById('prev-step')?.addEventListener('click', () => {
                this.prevStep();
            });
            
            document.getElementById('next-step')?.addEventListener('click', () => {
                this.nextStep();
            });
            
            document.getElementById('submit-form')?.addEventListener('click', () => {
                this.submitForm();
            });
            
            // Navegación por clic en steps
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', (e) => {
                    const stepNumber = parseInt(step.getAttribute('data-step'));
                    if (stepNumber < this.currentStep) {
                        this.goToStep(stepNumber);
                    }
                });
            });
            
            // Validación de RUT
            document.getElementById('validate-rut')?.addEventListener('click', () => {
                this.validateRUT();
            });
            
            // Cambios en tipo de contrato
            document.getElementById('tipo_contrato_id')?.addEventListener('change', (e) => {
                this.handleContractTypeChange(e.target.value);
            });
            
            // Cambios en región
            document.getElementById('region_id')?.addEventListener('change', (e) => {
                this.loadCommunes(e.target.value);
            });
            
            // Validación en tiempo real
            this.setupRealTimeValidation();
            
            // Cálculos automáticos
            this.setupAutoCalculations();
            
            // Vista previa organizacional
            this.setupOrgPreview();
        }
        
        openModal(employeeId = null) {
            this.resetForm();
            if (employeeId) {
                this.loadEmployeeData(employeeId);
                document.getElementById('employeeModalTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>Editar Empleado';
                document.getElementById('employeeModalSubtitle').textContent = 'Modifique la información del empleado seleccionado';
            } else {
                document.getElementById('employeeModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Agregar Nuevo Empleado';
                document.getElementById('employeeModalSubtitle').textContent = 'Complete toda la información requerida del empleado';
            }
            this.modal.show();
        }
        
        resetForm() {
            this.currentStep = 1;
            this.formData = {};
            this.updateStepNavigation();
            this.updateProgressBar();
            this.resetValidation();
            
            // Resetear todos los campos del formulario
            this.form.reset();
            
            // Resetear selects dependientes
            document.getElementById('comuna_id').innerHTML = '<option value="">-- Primero elija una región --</option>';
            document.getElementById('comuna_id').disabled = true;
            document.getElementById('campo-vencimiento').style.display = 'none';
            
            // Ocultar vistas previas
            document.getElementById('contract-preview').classList.add('d-none');
        }
        
        updateStepNavigation() {
            // Actualizar clases de steps
            document.querySelectorAll('.step').forEach(step => {
                const stepNumber = parseInt(step.getAttribute('data-step'));
                step.classList.remove('active', 'completed');
                
                if (stepNumber === this.currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < this.currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Mostrar/ocultar botones de navegación
            document.getElementById('prev-step').style.display = this.currentStep > 1 ? 'block' : 'none';
            document.getElementById('next-step').style.display = this.currentStep < this.totalSteps ? 'block' : 'none';
            document.getElementById('submit-form').style.display = this.currentStep === this.totalSteps ? 'block' : 'none';
            
            // Mostrar/ocultar contenido de steps
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
                if (parseInt(content.getAttribute('data-step')) === this.currentStep) {
                    content.classList.add('active');
                }
            });
        }
        
        updateProgressBar() {
            const progress = ((this.currentStep - 1) / (this.totalSteps - 1)) * 100;
            document.getElementById('form-progress').style.width = `${progress}%`;
        }
        
        prevStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
                this.updateStepNavigation();
                this.updateProgressBar();
            }
        }
        
        async nextStep() {
            // Validar paso actual antes de avanzar
            if (await this.validateCurrentStep()) {
                if (this.currentStep < this.totalSteps) {
                    this.currentStep++;
                    this.updateStepNavigation();
                    this.updateProgressBar();
                    
                    // Acciones específicas por paso
                    if (this.currentStep === 4) {
                        this.prepareReviewStep();
                    }
                }
            }
        }
        
        goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= this.totalSteps) {
                this.currentStep = stepNumber;
                this.updateStepNavigation();
                this.updateProgressBar();
            }
        }
        
        async validateCurrentStep() {
            const currentStepElement = document.querySelector(`.step-content[data-step="${this.currentStep}"]`);
            const inputs = currentStepElement.querySelectorAll('[data-validation]');
            let isValid = true;
            
            // Resetear validaciones previas
            this.resetStepValidation(currentStepElement);
            
            // Validar cada campo
            for (const input of inputs) {
                const validationType = input.getAttribute('data-validation');
                const value = input.value.trim();
                
                if (!this.validateField(input, value, validationType)) {
                    isValid = false;
                    this.showFieldError(input, this.getValidationMessage(validationType, input));
                } else {
                    this.showFieldSuccess(input);
                    // Guardar dato validado
                    this.formData[input.name] = value;
                }
            }
            
            if (!isValid) {
                // Mostrar notificación de error
                showToast('Por favor, corrija los errores antes de continuar', 'error');
                
                // Scroll al primer error
                const firstError = currentStepElement.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            return isValid;
        }
        
        validateField(input, value, validationType) {
            switch (validationType) {
                case 'required':
                    return value !== '';
                case 'email':
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
                case 'rut':
                    return this.validateRUTFormat(value);
                case 'phone':
                    return /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/.test(value);
                case 'date':
                    return value === '' || !isNaN(Date.parse(value));
                default:
                    return true;
            }
        }
        
        validateRUTFormat(rut) {
            // Validación básica de formato RUT chileno
            if (!rut) return false;
            return /^[0-9]{7,8}-[0-9kK]{1}$/.test(rut);
        }
        
        getValidationMessage(validationType, input) {
            const labels = {
                'required': 'Este campo es obligatorio',
                'email': 'Ingrese un email válido',
                'rut': 'Formato de RUT inválido (12345678-9)',
                'phone': 'Formato de teléfono inválido',
                'date': 'Fecha inválida'
            };
            
            return labels[validationType] || 'Campo inválido';
        }
        
        showFieldError(input, message) {
            input.classList.add('is-invalid');
            const feedback = input.closest('.form-group')?.querySelector('.form-feedback') || 
                            input.parentElement.nextElementSibling;
            if (feedback) {
                feedback.textContent = message;
                feedback.className = 'form-feedback invalid';
            }
        }
        
        showFieldSuccess(input) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            const feedback = input.closest('.form-group')?.querySelector('.form-feedback') || 
                            input.parentElement.nextElementSibling;
            if (feedback) {
                feedback.textContent = '';
                feedback.className = 'form-feedback';
            }
        }
        
        resetStepValidation(stepElement) {
            const inputs = stepElement.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            const feedbacks = stepElement.querySelectorAll('.form-feedback');
            feedbacks.forEach(feedback => {
                feedback.textContent = '';
                feedback.className = 'form-feedback';
            });
        }
        
        resetValidation() {
            this.resetStepValidation(this.form);
        }
        
        validateRUT() {
            const rutInput = document.getElementById('rut');
            const rut = rutInput.value.trim();
            
            if (this.validateRUTFormat(rut)) {
                this.showFieldSuccess(rutInput);
                showToast('RUT válido', 'success');
                return true;
            } else {
                this.showFieldError(rutInput, 'Formato de RUT inválido. Ejemplo: 12345678-9');
                return false;
            }
        }
        
        handleContractTypeChange(type) {
            const vencimientoField = document.getElementById('campo-vencimiento');
            if (type === '2') { // Plazo Fijo
                vencimientoField.style.display = 'block';
            } else {
                vencimientoField.style.display = 'none';
            }
            this.updateContractPreview();
        }
        
        loadCommunes(regionId) {
            const comunaSelect = document.getElementById('comuna_id');
            
            if (!regionId) {
                comunaSelect.innerHTML = '<option value="">-- Primero elija una región --</option>';
                comunaSelect.disabled = true;
                return;
            }
            
            // Simular carga de comunas (en una aplicación real, esto sería una llamada AJAX)
            const comunas = {
                '1': ['Santiago', 'Providencia', 'Las Condes', 'Ñuñoa', 'Maipú'],
                '2': ['Valparaíso', 'Viña del Mar', 'Quilpué', 'Villa Alemana', 'Concón'],
                '3': ['Concepción', 'Talcahuano', 'Chiguayante', 'San Pedro de la Paz', 'Coronel']
            };
            
            comunaSelect.innerHTML = '<option value="">-- Seleccione Comuna --</option>';
            comunas[regionId]?.forEach(comuna => {
                comunaSelect.innerHTML += `<option value="${comuna}">${comuna}</option>`;
            });
            
            comunaSelect.disabled = false;
        }
        
        setupRealTimeValidation() {
            // Validación en tiempo real para campos con data-validation
            document.querySelectorAll('[data-validation]').forEach(input => {
                input.addEventListener('blur', () => {
                    const value = input.value.trim();
                    const validationType = input.getAttribute('data-validation');
                    
                    if (value === '') {
                        input.classList.remove('is-invalid', 'is-valid');
                    } else if (this.validateField(input, value, validationType)) {
                        this.showFieldSuccess(input);
                    } else {
                        this.showFieldError(input, this.getValidationMessage(validationType, input));
                    }
                });
            });
        }
        
        setupAutoCalculations() {
            // Calcular edad automáticamente
            document.getElementById('fecha_nacimiento')?.addEventListener('change', (e) => {
                this.calculateAge(e.target.value);
            });
            
            // Calcular antigüedad automáticamente
            document.getElementById('fecha_ingreso')?.addEventListener('change', (e) => {
                this.calculateTenure(e.target.value);
            });
        }
        
        calculateAge(birthDate) {
            if (!birthDate) return;
            
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            
            // Ajustar si aún no ha pasado el cumpleaños este año
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            const ageDisplay = document.querySelector('.age-display');
            if (ageDisplay) {
                ageDisplay.textContent = `${age} años`;
            }
        }
        
        calculateTenure(joinDate) {
            if (!joinDate) return;
            
            const today = new Date();
            const join = new Date(joinDate);
            let years = today.getFullYear() - join.getFullYear();
            let months = today.getMonth() - join.getMonth();
            
            if (months < 0) {
                years--;
                months += 12;
            }
            
            const tenureDisplay = document.querySelector('.tenure-display');
            if (tenureDisplay) {
                tenureDisplay.textContent = `${years} años, ${months} meses`;
            }
            
            this.updateContractPreview();
        }
        
        updateContractPreview() {
            const contractType = document.getElementById('tipo_contrato_id').value;
            const joinDate = document.getElementById('fecha_ingreso').value;
            const endDate = document.getElementById('fecha_vencimiento_contrato').value;
            
            if (!contractType) {
                document.getElementById('contract-preview').classList.add('d-none');
                return;
            }
            
            const preview = document.getElementById('contract-preview');
            const details = preview.querySelector('.contract-details');
            
            let html = '';
            
            if (contractType === '1') { // Indefinido
                html = `
                    <div class="contract-detail">
                        <strong>Tipo de Contrato</strong>
                        <span>Indefinido</span>
                    </div>
                    <div class="contract-detail">
                        <strong>Fecha de Ingreso</strong>
                        <span>${joinDate ? new Date(joinDate).toLocaleDateString() : 'No especificada'}</span>
                    </div>
                    <div class="contract-detail">
                        <strong>Duración</strong>
                        <span>Indefinida</span>
                    </div>
                `;
            } else if (contractType === '2') { // Plazo Fijo
                html = `
                    <div class="contract-detail">
                        <strong>Tipo de Contrato</strong>
                        <span>Plazo Fijo</span>
                    </div>
                    <div class="contract-detail">
                        <strong>Fecha de Ingreso</strong>
                        <span>${joinDate ? new Date(joinDate).toLocaleDateString() : 'No especificada'}</span>
                    </div>
                    <div class="contract-detail">
                        <strong>Fecha de Término</strong>
                        <span>${endDate ? new Date(endDate).toLocaleDateString() : 'No especificada'}</span>
                    </div>
                    <div class="contract-detail">
                        <strong>Duración</strong>
                        <span>${endDate && joinDate ? this.calculateDuration(joinDate, endDate) : 'No calculable'}</span>
                    </div>
                `;
            }
            
            details.innerHTML = html;
            preview.classList.remove('d-none');
        }
        
        calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const months = Math.floor(diffDays / 30);
            const days = diffDays % 30;
            
            return `${months} meses, ${days} días`;
        }
        
        setupOrgPreview() {
            // Actualizar vista previa organizacional cuando cambien los campos relevantes
            const orgFields = ['cargo_id', 'area_id', 'turno_id', 'supervision_id', 'fase_id'];
            
            orgFields.forEach(field => {
                document.getElementById(field)?.addEventListener('change', () => {
                    this.updateOrgPreview();
                });
            });
        }
        
        updateOrgPreview() {
            const cargo = document.getElementById('cargo_id');
            const area = document.getElementById('area_id');
            const turno = document.getElementById('turno_id');
            const supervision = document.getElementById('supervision_id');
            const fase = document.getElementById('fase_id');
            
            const orgChart = document.getElementById('org-chart');
            
            if (!cargo.value && !area.value && !turno.value && !supervision.value && !fase.value) {
                orgChart.innerHTML = '<p class="text-muted">Complete los campos organizacionales para ver la vista previa</p>';
                return;
            }
            
            let html = '<div class="org-level">';
            
            if (fase.value) {
                html += `<div class="org-item">Fase ${fase.options[fase.selectedIndex].text}</div>`;
            }
            
            if (supervision.value) {
                html += `<div class="org-item">${supervision.options[supervision.selectedIndex].text}</div>`;
            }
            
            if (area.value) {
                html += `<div class="org-item">${area.options[area.selectedIndex].text}</div>`;
            }
            
            if (turno.value) {
                html += `<div class="org-item">Turno ${turno.options[turno.selectedIndex].text}</div>`;
            }
            
            if (cargo.value) {
                html += `<div class="org-item highlight">${cargo.options[cargo.selectedIndex].text}</div>`;
            }
            
            html += '</div>';
            
            orgChart.innerHTML = html;
        }
        
        prepareReviewStep() {
            const reviewCards = document.querySelector('.review-cards');
            if (!reviewCards) return;
            
            // Recopilar todos los datos del formulario
            const formData = new FormData(this.form);
            const data = Object.fromEntries(formData.entries());
            
            // Agrupar datos por sección
            const sections = {
                'Información Personal': ['rut', 'nombre_completo', 'fecha_nacimiento', 'telefono', 'email', 'direccion', 'region_id', 'comuna_id'],
                'Información Laboral': ['id_sap_local', 'id_sap_global', 'fecha_ingreso', 'tipo_contrato_id', 'fecha_vencimiento_contrato'],
                'Asignaciones': ['cargo_id', 'area_id', 'turno_id', 'supervision_id', 'fase_id', 'relacion_laboral_id', 'status_id']
            };
            
            let html = '';
            
            for (const [sectionName, fields] of Object.entries(sections)) {
                let sectionHtml = `
                    <div class="review-card">
                        <h6><i class="fas fa-${this.getSectionIcon(sectionName)} me-2"></i>${sectionName}</h6>
                        <div class="review-items">
                `;
                
                for (const field of fields) {
                    const value = data[field] || 'No especificado';
                    const label = this.getFieldLabel(field);
                    
                    sectionHtml += `
                        <div class="review-item">
                            <span class="review-label">${label}:</span>
                            <span class="review-value ${!value ? 'empty' : ''}">${this.formatValue(field, value)}</span>
                        </div>
                    `;
                }
                
                sectionHtml += `
                        </div>
                    </div>
                `;
                
                html += sectionHtml;
            }
            
            reviewCards.innerHTML = html;
        }
        
        getSectionIcon(sectionName) {
            const icons = {
                'Información Personal': 'user',
                'Información Laboral': 'briefcase',
                'Asignaciones': 'sitemap'
            };
            return icons[sectionName] || 'info-circle';
        }
        
        getFieldLabel(fieldName) {
            const labels = {
                'rut': 'RUT',
                'nombre_completo': 'Nombre',
                'fecha_nacimiento': 'Fecha Nacimiento',
                'telefono': 'Teléfono',
                'email': 'Email',
                'direccion': 'Dirección',
                'region_id': 'Región',
                'comuna_id': 'Comuna',
                'id_sap_local': 'ID SAP Local',
                'id_sap_global': 'ID SAP Global',
                'fecha_ingreso': 'Fecha Ingreso',
                'tipo_contrato_id': 'Tipo Contrato',
                'fecha_vencimiento_contrato': 'Fecha Término',
                'cargo_id': 'Cargo',
                'area_id': 'Área',
                'turno_id': 'Turno',
                'supervision_id': 'Supervisión',
                'fase_id': 'Fase',
                'relacion_laboral_id': 'Relación Laboral',
                'status_id': 'Status'
            };
            return labels[fieldName] || fieldName;
        }
        
        formatValue(field, value) {
            if (!value) return 'No especificado';
            
            // Formatear fechas
            if (field.includes('fecha')) {
                return new Date(value).toLocaleDateString();
            }
            
            // Formatear selects
            if (field.endsWith('_id')) {
                const select = document.getElementById(field);
                if (select) {
                    const option = select.querySelector(`option[value="${value}"]`);
                    if (option) return option.textContent;
                }
            }
            
            return value;
        }
        
        async submitForm() {
            // Validar confirmación
            if (!document.getElementById('confirm-data').checked) {
                showToast('Debe confirmar que la información es correcta', 'error');
                return;
            }
            
            // Mostrar modal de carga
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            const loadingTitle = document.getElementById('loading-title');
            const loadingMessage = document.getElementById('loading-message');
            const currentStep = document.getElementById('current-step');
            const detailedProgress = document.getElementById('detailed-progress');
            
            loadingTitle.textContent = 'Guardando Empleado';
            loadingMessage.textContent = 'Por favor espere mientras guardamos la información del empleado';
            currentStep.textContent = 'Iniciando proceso...';
            detailedProgress.style.width = '0%';
            
            loadingModal.show();
            
            try {
                // Simular proceso de guardado
                const steps = [
                    'Validando información',
                    'Guardando datos personales',
                    'Registrando información laboral',
                    'Actualizando asignaciones',
                    'Generando documentos',
                    'Finalizando proceso'
                ];
                
                for (let i = 0; i < steps.length; i++) {
                    currentStep.textContent = steps[i];
                    detailedProgress.style.width = `${(i / (steps.length - 1)) * 100}%`;
                    
                    // Simular tiempo de proceso
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
                
                // Simular éxito
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Cerrar modales
                loadingModal.hide();
                this.modal.hide();
                
                // Mostrar notificación de éxito
                showToast('Empleado guardado correctamente', 'success');
                
                // Recargar o actualizar la lista de empleados
                setTimeout(() => {
                    // En una aplicación real, aquí se actualizaría la lista
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error('Error al guardar:', error);
                loadingModal.hide();
                showToast('Error al guardar el empleado', 'error');
            }
        }
        
        loadEmployeeData(employeeId) {
            // Simular carga de datos de empleado
            // En una aplicación real, esto sería una llamada AJAX
            console.log('Cargando datos del empleado:', employeeId);
            
            // Datos de ejemplo
            const exampleData = {
                rut: '12345678-9',
                nombre_completo: 'Juan Pérez González',
                fecha_nacimiento: '1985-05-15',
                telefono: '+56 9 1234 5678',
                email: 'juan.perez@empresa.com',
                direccion: 'Av. Principal 123, Santiago',
                region_id: '1',
                comuna_id: 'Santiago',
                id_sap_local: 'EMP001',
                id_sap_global: 'GLB001',
                fecha_ingreso: '2020-01-15',
                tipo_contrato_id: '1',
                cargo_id: '1',
                area_id: '1',
                turno_id: '1',
                supervision_id: '1',
                fase_id: '1',
                relacion_laboral_id: '2',
                status_id: '1'
            };
            
            // Llenar el formulario con los datos
            Object.entries(exampleData).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                    
                    // Disparar eventos change para selects
                    if (element.tagName === 'SELECT') {
                        element.dispatchEvent(new Event('change'));
                    }
                }
            });
            
            // Actualizar cálculos
            this.calculateAge(exampleData.fecha_nacimiento);
            this.calculateTenure(exampleData.fecha_ingreso);
            this.updateContractPreview();
            this.updateOrgPreview();
        }
    }

    /* ===================================================================== */
    /* JAVASCRIPT PARA IMPORTACIÓN CON VALIDACIÓN EN TIEMPO REAL            */
    /* ===================================================================== */

    class RealTimeImportValidator {
        constructor() {
            this.currentStep = 1;
            this.fileData = null;
            this.validationResults = null;
            this.init();
            this.bindEvents();
        }
        
        init() {
            this.modal = new bootstrap.Modal(document.getElementById('realTimeImportModal'));
            this.dropzone = document.getElementById('advanced-dropzone');
            this.fileInput = document.getElementById('advanced-file-input');
            this.browseBtn = document.getElementById('browse-advanced');
        }
        
        bindEvents() {
            // Abrir modal
            document.getElementById('open-import-modal')?.addEventListener('click', () => {
                this.openModal();
            });
            
            // Navegación entre pasos
            document.getElementById('prev-import-step')?.addEventListener('click', () => {
                this.prevStep();
            });
            
            document.getElementById('next-import-step')?.addEventListener('click', () => {
                this.nextStep();
            });
            
            document.getElementById('start-import')?.addEventListener('click', () => {
                this.startImport();
            });
            
            // Drag & Drop
            this.dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                this.dropzone.classList.add('drag-over');
            });
            
            this.dropzone.addEventListener('dragleave', () => {
                this.dropzone.classList.remove('drag-over');
            });
            
            this.dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                this.dropzone.classList.remove('drag-over');
                this.handleFileDrop(e.dataTransfer.files);
            });
            
            this.browseBtn.addEventListener('click', () => {
                this.fileInput.click();
            });
            
            this.fileInput.addEventListener('change', (e) => {
                this.handleFileSelect(e.target.files);
            });
            
            // Acciones de corrección
            document.getElementById('auto-fix-all')?.addEventListener('click', () => {
                this.autoFixAllErrors();
            });
            
            document.getElementById('skip-errors')?.addEventListener('click', () => {
                this.skipAllErrors();
            });
            
            document.getElementById('export-errors')?.addEventListener('click', () => {
                this.exportErrors();
            });
            
            // Cancelar importación
            document.getElementById('cancel-import')?.addEventListener('click', () => {
                this.cancelImport();
            });
        }
        
        openModal() {
            this.resetModal();
            this.modal.show();
        }
        
        resetModal() {
            this.currentStep = 1;
            this.fileData = null;
            this.validationResults = null;
            this.updateStepNavigation();
            
            // Reset UI
            this.dropzone.classList.remove('drag-over');
            document.querySelector('.drop-content').style.display = 'block';
            document.getElementById('validation-log').innerHTML = '';
            document.getElementById('preview-table').innerHTML = '';
            document.getElementById('errors-container').innerHTML = '';
            
            // Reset stats
            this.updateStats(0, 0, 0, 0);
        }
        
        updateStepNavigation() {
            // Actualizar steps
            document.querySelectorAll('.import-step').forEach(step => {
                step.classList.remove('active');
                if (parseInt(step.getAttribute('data-step')) === this.currentStep) {
                    step.classList.add('active');
                }
            });
            
            document.querySelectorAll('.step-indicator .step').forEach(step => {
                step.classList.remove('active');
                if (parseInt(step.getAttribute('data-step')) === this.currentStep) {
                    step.classList.add('active');
                }
            });
            
            // Actualizar botones
            document.getElementById('prev-import-step').style.display = this.currentStep > 1 ? 'block' : 'none';
            
            if (this.currentStep < 4) {
                document.getElementById('next-import-step').style.display = 'block';
                document.getElementById('start-import').style.display = 'none';
            } else {
                document.getElementById('next-import-step').style.display = 'none';
                document.getElementById('start-import').style.display = 'block';
            }
            
            // Actualizar estado
            document.getElementById('import-status').textContent = this.getStatusMessage();
        }
        
        getStatusMessage() {
            const messages = {
                1: 'Listo para seleccionar archivo',
                2: this.fileData ? `Validando ${this.fileData.length} registros...` : 'Esperando archivo',
                3: this.validationResults ? `Preparando ${this.validationResults.errors.length} correcciones...` : 'Procesando validación...',
                4: 'Listo para importar'
            };
            return messages[this.currentStep] || '';
        }
        
        prevStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
                this.updateStepNavigation();
            }
        }
        
        async nextStep() {
            if (this.currentStep === 1 && !this.fileData) {
                showToast('Por favor seleccione un archivo primero', 'error');
                return;
            }
            
            if (this.currentStep === 2 && !this.validationResults) {
                await this.validateData();
            }
            
            if (this.currentStep < 4) {
                this.currentStep++;
                this.updateStepNavigation();
                
                if (this.currentStep === 3) {
                    this.prepareErrorCorrection();
                } else if (this.currentStep === 4) {
                    this.prepareFinalSummary();
                }
            }
        }
        
        handleFileDrop(files) {
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        }
        
        handleFileSelect(files) {
            if (files.length > 0) {
                this.processFile(files[0]);
            }
        }
        
        async processFile(file) {
            try {
                // Validar tipo de archivo
                if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    showToast('Solo se permiten archivos Excel o CSV', 'error');
                    return;
                }
                
                // Mostrar indicador de carga
                this.dropzone.classList.add('uploading');
                document.querySelector('.drop-content').style.display = 'none';
                
                // Leer archivo
                const data = await this.readFile(file);
                this.fileData = data;
                
                // Avanzar al siguiente paso automáticamente
                setTimeout(() => {
                    this.nextStep();
                }, 500);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showToast('Error al procesar el archivo', 'error');
                this.dropzone.classList.remove('uploading');
                document.querySelector('.drop-content').style.display = 'block';
            }
        }
        
        async readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        // Simular lectura de datos (en una aplicación real, usaría SheetJS)
                        const data = this.simulateFileData();
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Error reading file'));
                
                if (file.name.match(/\.csv$/i)) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }
        
        simulateFileData() {
            // Simular datos de archivo (en una aplicación real, estos vendrían del archivo)
            return [
                { rut: '12345678-9', nombre: 'Juan Pérez', email: 'juan@email.com', cargo: 'Analista', area: 'TI' },
                { rut: '98765432-1', nombre: 'María González', email: 'maria@email.com', cargo: 'Gerente', area: 'RH' },
                { rut: 'invalid-rut', nombre: '', email: 'invalid-email', cargo: '', area: '' },
                { rut: '55555555-5', nombre: 'Carlos López', email: 'carlos@email.com', cargo: 'Desarrollador', area: 'TI' }
            ];
        }
        
        async validateData() {
            if (!this.fileData) return;
            
            // Mostrar progreso de validación
            const progressBar = document.getElementById('validation-progress');
            const logContainer = document.getElementById('validation-log');
            
            progressBar.style.width = '0%';
            logContainer.innerHTML = '<div class="log-entry info">Iniciando validación...</div>';
            
            // Simular validación progresiva
            const totalRows = this.fileData.length;
            let validRows = 0;
            let warningRows = 0;
            let errorRows = 0;
            
            this.validationResults = {
                valid: [],
                warnings: [],
                errors: [],
                stats: { total: totalRows, valid: 0, warnings: 0, errors: 0 }
            };
            
            for (let i = 0; i < totalRows; i++) {
                const row = this.fileData[i];
                const result = this.validateRow(row, i + 1);
                
                // Actualizar estadísticas
                if (result.status === 'valid') {
                    validRows++;
                    this.validationResults.valid.push(result);
                } else if (result.status === 'warning') {
                    warningRows++;
                    this.validationResults.warnings.push(result);
                } else {
                    errorRows++;
                    this.validationResults.errors.push(result);
                }
                
                // Actualizar progreso
                const progress = ((i + 1) / totalRows) * 100;
                progressBar.style.width = `${progress}%`;
                
                // Agregar al log
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${result.status}`;
                logEntry.innerHTML = `<strong>Fila ${i + 1}:</strong> ${result.message}`;
                logContainer.appendChild(logEntry);
                
                // Scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Pequeña pausa para simular procesamiento
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Actualizar estadísticas finales
            this.updateStats(totalRows, validRows, warningRows, errorRows);
            
            // Generar vista previa de tabla
            this.generatePreviewTable();
            
            // Mostrar resumen
            logContainer.innerHTML += `
                <div class="log-entry success">Validación completada: ${validRows} válidos, ${warningRows} advertencias, ${errorRows} errores</div>
            `;
        }
        
        validateRow(row, rowNumber) {
            // Simular validación de fila
            const errors = [];
            
            // Validar RUT
            if (!row.rut || !/^[0-9]{7,8}-[0-9kK]{1}$/.test(row.rut)) {
                errors.push('RUT inválido');
            }
            
            // Validar nombre
            if (!row.nombre || row.nombre.trim().length < 3) {
                errors.push('Nombre muy corto');
            }
            
            // Validar email
            if (!row.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(row.email)) {
                errors.push('Email inválido');
            }
            
            // Validar cargo
            if (!row.cargo) {
                errors.push('Cargo requerido');
            }
            
            if (errors.length === 0) {
                return { status: 'valid', message: 'Fila válida', row: rowNumber, data: row };
            } else if (errors.length <= 2) {
                return { status: 'warning', message: `Advertencias: ${errors.join(', ')}`, row: rowNumber, data: row, errors };
            } else {
                return { status: 'error', message: `Errores: ${errors.join(', ')}`, row: rowNumber, data: row, errors };
            }
        }
        
        updateStats(total, valid, warnings, errors) {
            document.getElementById('total-rows').textContent = total;
            document.getElementById('valid-rows').textContent = valid;
            document.getElementById('warning-rows').textContent = warnings;
            document.getElementById('error-rows').textContent = errors;
            
            // Actualizar también en el paso final
            document.getElementById('final-valid').textContent = valid;
            document.getElementById('final-warnings').textContent = warnings;
            document.getElementById('final-errors').textContent = errors;
        }
        
        generatePreviewTable() {
            if (!this.fileData || this.fileData.length === 0) return;
            
            const table = document.getElementById('preview-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            // Crear encabezados
            const headers = Object.keys(this.fileData[0]);
            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}<th>Estado</th></tr>`;
            
            // Crear filas
            this.fileData.forEach((row, index) => {
                const result = this.validationResults.valid.concat(this.validationResults.warnings, this.validationResults.errors)
                    .find(r => r.row === index + 1);
                
                const status = result?.status || 'unknown';
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    ${headers.map(h => `<td class="${this.getCellClass(status, h)}">${row[h] || ''}</td>`).join('')}
                    <td><span class="badge bg-${this.getStatusBadge(status)}">${this.getStatusText(status)}</span></td>
                `;
                
                tbody.appendChild(tr);
            });
            
            table.innerHTML = '';
            table.appendChild(thead);
            table.appendChild(tbody);
        }
        
        getCellClass(status, field) {
            if (status === 'valid') return 'cell-valid';
            if (status === 'warning') return 'cell-warning';
            if (status === 'error') return 'cell-error';
            return '';
        }
        
        getStatusBadge(status) {
            const badges = { valid: 'success', warning: 'warning', error: 'danger' };
            return badges[status] || 'secondary';
        }
        
        getStatusText(status) {
            const texts = { valid: 'Válido', warning: 'Advertencia', error: 'Error' };
            return texts[status] || 'Desconocido';
        }
        
        prepareErrorCorrection() {
            if (!this.validationResults || this.validationResults.errors.length === 0) {
                document.getElementById('errors-container').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        No se encontraron errores que requieran corrección.
                    </div>
                `;
                return;
            }
            
            const container = document.getElementById('errors-container');
            container.innerHTML = '';
            
            this.validationResults.errors.forEach((error, index) => {
                const errorItem = document.createElement('div');
                errorItem.className = 'error-item';
                errorItem.innerHTML = `
                    <div class="error-header">
                        <div class="error-info">
                            <div class="error-row">Fila ${error.row}</div>
                            <div class="error-message">${error.message}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary toggle-error" data-bs-toggle="collapse" data-bs-target="#error-detail-${index}">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="collapse" id="error-detail-${index}">
                        <div class="error-details mt-2">
                            ${Object.entries(error.data).map(([key, value]) => `
                                <div class="mb-2">
                                    <label class="form-label">${key}</label>
                                    <input type="text" class="form-control" value="${value || ''}" 
                                           data-row="${error.row}" data-field="${key}">
                                </div>
                            `).join('')}
                        </div>
                        <div class="error-suggestion">
                            <strong>Sugerencia:</strong> ${this.getSuggestion(error)}
                        </div>
                        <div class="error-actions mt-2">
                            <button class="btn btn-sm btn-success apply-fix" data-row="${error.row}">
                                <i class="fas fa-check me-1"></i>Aplicar Corrección
                            </button>
                            <button class="btn btn-sm btn-outline-secondary skip-error" data-row="${error.row}">
                                <i class="fas fa-forward me-1"></i>Saltar Error
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(errorItem);
            });
            
            // Bind events for correction buttons
            container.querySelectorAll('.apply-fix').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const row = parseInt(e.target.getAttribute('data-row'));
                    this.applyFix(row);
                });
            });
            
            container.querySelectorAll('.skip-error').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const row = parseInt(e.target.getAttribute('data-row'));
                    this.skipError(row);
                });
            });
        }
        
        getSuggestion(error) {
            // Sugerencias simples basadas en el tipo de error
            if (error.errors.includes('RUT inválido')) {
                return 'El RUT debe tener formato 12345678-9';
            }
            if (error.errors.includes('Email inválido')) {
                return 'El email debe tener formato válido: usuario@dominio.com';
            }
            return 'Revise los datos ingresados y corrija los valores incorrectos';
        }
        
        applyFix(rowNumber) {
            // En una aplicación real, esto aplicaría las correcciones
            showToast(`Corrección aplicada para fila ${rowNumber}`, 'success');
            
            // Marcar como corregido
            const errorItem = document.querySelector(`[data-row="${rowNumber}"]`).closest('.error-item');
            errorItem.classList.add('corrected');
            
            // Actualizar estadísticas
            const errorIndex = this.validationResults.errors.findIndex(e => e.row === rowNumber);
            if (errorIndex !== -1) {
                this.validationResults.errors.splice(errorIndex, 1);
                this.validationResults.valid.push({ status: 'valid', row: rowNumber });
            }
        }
        
        skipError(rowNumber) {
            // Marcar error como omitido
            const errorItem = document.querySelector(`[data-row="${rowNumber}"]`).closest('.error-item');
            errorItem.style.opacity = '0.5';
            
            showToast(`Error en fila ${rowNumber} omitido`, 'warning');
        }
        
        autoFixAllErrors() {
            // Simular corrección automática de todos los errores
            showToast('Aplicando correcciones automáticas...', 'info');
            
            setTimeout(() => {
                this.validationResults.errors.forEach(error => {
                    this.applyFix(error.row);
                });
                
                showToast('Todas las correcciones aplicadas automáticamente', 'success');
            }, 2000);
        }
        
        skipAllErrors() {
            if (this.validationResults.errors.length === 0) return;
            
            if (confirm(`¿Está seguro de que desea omitir los ${this.validationResults.errors.length} errores restantes?`)) {
                this.validationResults.errors = [];
                document.getElementById('errors-container').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Todos los errores han sido omitidos. Puede que algunos registros no se importen correctamente.
                    </div>
                `;
            }
        }
        
        exportErrors() {
            // Simular exportación de errores a CSV
            showToast('Generando archivo de errores...', 'info');
            
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = 'data:text/csv;charset=utf-8,errors';
                link.download = 'errores_importacion.csv';
                link.click();
                
                showToast('Archivo de errores descargado', 'success');
            }, 1000);
        }
        
        prepareFinalSummary() {
            // Actualizar estadísticas finales
            if (this.validationResults) {
                const total = this.validationResults.stats.total;
                const valid = this.validationResults.valid.length;
                const warnings = this.validationResults.warnings.length;
                const errors = this.validationResults.errors.length;
                
                this.updateStats(total, valid, warnings, errors);
                document.getElementById('processing-time').textContent = '3.5s'; // Simulado
            }
        }
        
        async startImport() {
            if (!this.validationResults) return;
            
            // Mostrar modal de progreso de importación
            const importModal = new bootstrap.Modal(document.getElementById('importProgressModal'));
            const progressBar = document.getElementById('import-progress-bar');
            const currentRecord = document.getElementById('current-record');
            const totalRecords = document.getElementById('total-records');
            const liveUpdates = document.getElementById('live-updates');
            const cancelBtn = document.getElementById('cancel-import');
            
            const total = this.validationResults.valid.length + this.validationResults.warnings.length;
            totalRecords.textContent = total;
            currentRecord.textContent = '0';
            progressBar.style.width = '0%';
            liveUpdates.innerHTML = '<div class="update-line">Preparando importación...</div>';
            cancelBtn.style.display = 'block';
            
            importModal.show();
            
            // Simular proceso de importación
            let imported = 0;
            let errors = 0;
            
            const processRecord = async (record, index) => {
                await new Promise(resolve => setTimeout(resolve, 200)); // Simular procesamiento
                
                imported++;
                currentRecord.textContent = imported;
                progressBar.style.width = `${(imported / total) * 100}%`;
                
                // Agregar update
                const update = document.createElement('div');
                update.className = 'update-line';
                update.textContent = `Importado: ${record.data?.nombre || `Registro ${index + 1}`}`;
                liveUpdates.appendChild(update);
                liveUpdates.scrollTop = liveUpdates.scrollHeight;
                
                // Simular error ocasional
                if (Math.random() < 0.1) {
                    errors++;
                    const errorUpdate = document.createElement('div');
                    errorUpdate.className = 'update-line error';
                    errorUpdate.textContent = `Error en: ${record.data?.nombre || `Registro ${index + 1}`}`;
                    liveUpdates.appendChild(errorUpdate);
                }
            };
            
            try {
                // Procesar registros válidos
                for (let i = 0; i < this.validationResults.valid.length; i++) {
                    if (this.cancelled) break;
                    await processRecord(this.validationResults.valid[i], i);
                }
                
                // Procesar registros con warning
                for (let i = 0; i < this.validationResults.warnings.length; i++) {
                    if (this.cancelled) break;
                    await processRecord(this.validationResults.warnings[i], i + this.validationResults.valid.length);
                }
                
                // Finalizar
                if (!this.cancelled) {
                    liveUpdates.innerHTML += `
                        <div class="update-line success">Importación completada: ${imported} registros, ${errors} errores</div>
                    `;
                    
                    setTimeout(() => {
                        importModal.hide();
                        this.modal.hide();
                        showToast(`Importación completada: ${imported} registros procesados`, 'success');
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Import error:', error);
                importModal.hide();
                showToast('Error durante la importación', 'error');
            }
        }
        
        cancelImport() {
            this.cancelled = true;
            const importModal = bootstrap.Modal.getInstance(document.getElementById('importProgressModal'));
            importModal.hide();
            showToast('Importación cancelada', 'warning');
        }
    }

    /* ===================================================================== */
    /* JAVASCRIPT PARA LA GESTIÓN DE EMPLEADOS (LISTA PRINCIPAL)            */
    /* ===================================================================== */

    class EmployeeListManager {
        constructor() {
            this.selectedEmployees = new Set();
            this.init();
            this.bindEvents();
        }
        
        init() {
            this.updateSelectionDisplay();
        }
        
        bindEvents() {
            // Checkbox principal (seleccionar todos)
            document.getElementById('select-all')?.addEventListener('change', (e) => {
                this.toggleSelectAll(e.target.checked);
            });
            
            // Checkboxes individuales
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    this.updateEmployeeSelection(e.target.value, e.target.checked);
                });
            });
            
            // Botones de selección rápida
            document.getElementById('select-all-visible')?.addEventListener('click', () => {
                this.selectAllVisible();
            });
            
            document.getElementById('deselect-all')?.addEventListener('click', () => {
                this.deselectAll();
            });
            
            document.getElementById('invert-selection')?.addEventListener('click', () => {
                this.invertSelection();
            });
            
            // Campos clickeables (RUT e ID SAP)
            document.querySelectorAll('.clickable-field').forEach(field => {
                field.addEventListener('click', (e) => {
                    const checkboxId = field.getAttribute('data-checkbox');
                    if (checkboxId) {
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                            
                            // Efecto visual de selección
                            field.classList.toggle('selected');
                        }
                    }
                });
            });
            
            // Cambio en la acción seleccionada
            document.getElementById('accion')?.addEventListener('change', (e) => {
                this.handleActionChange(e.target.value);
            });
            
            // Formulario de acciones masivas
            document.getElementById('bulk-form')?.addEventListener('submit', (e) => {
                this.handleBulkAction(e);
            });
            
            // Botones de edición
            document.querySelectorAll('.edit-employee-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const employeeId = e.target.closest('button').getAttribute('data-employee-id');
                    this.editEmployee(employeeId);
                });
            });
        }
        
        toggleSelectAll(checked) {
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                checkbox.checked = checked;
                this.updateEmployeeSelection(checkbox.value, checked);
            });
            
            // Actualizar visualmente los campos clickeables
            document.querySelectorAll('.clickable-field').forEach(field => {
                field.classList.toggle('selected', checked);
            });
        }
        
        updateEmployeeSelection(employeeId, isSelected) {
            if (isSelected) {
                this.selectedEmployees.add(employeeId);
            } else {
                this.selectedEmployees.delete(employeeId);
            }
            this.updateSelectionDisplay();
        }
        
        updateSelectionDisplay() {
            const count = this.selectedEmployees.size;
            const display = document.getElementById('selection-display');
            const message = document.getElementById('selection-message');
            const messageText = document.getElementById('message-text');
            
            if (count > 0) {
                display.style.display = 'inline-block';
                display.textContent = `${count} empleado${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
                
                message.style.display = 'block';
                if (count === 1) {
                    messageText.textContent = 'Puede realizar acciones individuales o seleccionar más empleados para acciones masivas.';
                } else {
                    messageText.textContent = `Tiene ${count} empleados seleccionados. Elija una acción masiva para aplicar a todos.`;
                }
            } else {
                display.style.display = 'none';
                message.style.display = 'none';
            }
            
            // Actualizar también el checkbox principal
            const totalCheckboxes = document.querySelectorAll('.employee-checkbox').length;
            const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked').length;
            const selectAll = document.getElementById('select-all');
            
            if (selectedCheckboxes === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (selectedCheckboxes === totalCheckboxes) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }
        
        selectAllVisible() {
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = true;
                    this.updateEmployeeSelection(checkbox.value, true);
                }
            });
            
            // Actualizar visualmente
            document.querySelectorAll('.clickable-field').forEach(field => {
                field.classList.add('selected');
            });
            
            showToast('Todos los empleados visibles seleccionados', 'success');
        }
        
        deselectAll() {
            this.selectedEmployees.clear();
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Actualizar visualmente
            document.querySelectorAll('.clickable-field').forEach(field => {
                field.classList.remove('selected');
            });
            
            this.updateSelectionDisplay();
            showToast('Selección limpiada', 'info');
        }
        
        invertSelection() {
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
                this.updateEmployeeSelection(checkbox.value, checkbox.checked);
                
                // Actualizar visualmente el campo correspondiente
                const field = document.querySelector(`.clickable-field[data-checkbox="${checkbox.id}"]`);
                if (field) {
                    field.classList.toggle('selected', checkbox.checked);
                }
            });
            
            showToast('Selección invertida', 'info');
        }
        
        handleActionChange(action) {
            const valorContainer = document.getElementById('valor-container');
            const fechaContainer = document.getElementById('fecha-container');
            
            // Ocultar todos los selects de valor primero
            document.querySelectorAll('.value-select').forEach(select => {
                select.style.display = 'none';
            });
            
            // Mostrar contenedores según el tipo de acción
            if (action.startsWith('planificar-')) {
                valorContainer.style.display = 'none';
                fechaContainer.style.display = 'block';
            } else if (action) {
                valorContainer.style.display = 'block';
                fechaContainer.style.display = 'none';
                
                // Mostrar el select correspondiente
                const selectId = `select_${action}`;
                const select = document.getElementById(selectId);
                if (select) {
                    select.style.display = 'block';
                }
            } else {
                valorContainer.style.display = 'none';
                fechaContainer.style.display = 'none';
            }
        }
        
        handleBulkAction(e) {
            e.preventDefault();
            
            if (this.selectedEmployees.size === 0) {
                showToast('Debe seleccionar al menos un empleado', 'error');
                return;
            }
            
            const action = document.getElementById('accion').value;
            if (!action) {
                showToast('Debe seleccionar una acción', 'error');
                return;
            }
            
            // Para acciones destructivas, pedir confirmación
            if (action === 'eliminar') {
                if (!confirm(`¿Está seguro de que desea eliminar ${this.selectedEmployees.size} empleado(s)? Esta acción no se puede deshacer.`)) {
                    return;
                }
            }
            
            // Aquí se enviaría el formulario en una aplicación real
            console.log('Ejecutando acción masiva:', action, 'para empleados:', Array.from(this.selectedEmployees));
            
            // Simular envío
            showToast(`Aplicando acción a ${this.selectedEmployees.size} empleado(s)...`, 'info');
            
            setTimeout(() => {
                showToast('Acción completada exitosamente', 'success');
                this.deselectAll();
            }, 2000);
        }
        
        editEmployee(employeeId) {
            // Usar el sistema de modales para editar
            if (window.employeeModalSystem) {
                window.employeeModalSystem.openModal(employeeId);
            } else {
                console.error('Sistema de modal no disponible');
                showToast('Error al cargar el editor de empleados', 'error');
            }
        }
    }

    /* ===================================================================== */
    /* RELOJ MODERNO EN TIEMPO REAL                                          */
    /* ===================================================================== */

    class ModernClock {
        constructor() {
            this.sessionStart = new Date();
            this.init();
            this.updateClock();
            setInterval(() => this.updateClock(), 1000);
        }
        
        init() {
            this.clockElement = document.getElementById('modern-clock');
            if (!this.clockElement) return;
            
            // Agregar efecto de tooltip
            this.clockElement.title = "Haga clic para alternar entre hora actual y tiempo de sesión";
            
            // Alternar entre hora y sesión al hacer clic
            this.clockElement.addEventListener('click', () => {
                this.clockElement.classList.toggle('show-session');
            });
        }
        
        updateClock() {
            const now = new Date();
            
            // Actualizar manecillas del reloj analógico
            this.updateAnalogClock(now);
            
            // Actualizar hora digital
            this.updateDigitalClock(now);
            
            // Actualizar tiempo de sesión
            this.updateSessionTime(now);
        }
        
        updateAnalogClock(now) {
            const seconds = now.getSeconds();
            const minutes = now.getMinutes();
            const hours = now.getHours() % 12;
            
            const secondHand = document.getElementById('second-hand');
            const minuteHand = document.getElementById('minute-hand');
            const hourHand = document.getElementById('hour-hand');
            
            if (secondHand) {
                secondHand.style.transform = `rotate(${seconds * 6}deg)`;
            }
            if (minuteHand) {
                minuteHand.style.transform = `rotate(${minutes * 6}deg)`;
            }
            if (hourHand) {
                hourHand.style.transform = `rotate(${hours * 30 + minutes * 0.5}deg)`;
            }
        }
        
        updateDigitalClock(now) {
            const timeDisplay = document.getElementById('time-display');
            if (timeDisplay) {
                timeDisplay.textContent = now.toLocaleTimeString();
            }
        }
        
        updateSessionTime(now) {
            const sessionDisplay = document.getElementById('session-display');
            if (sessionDisplay) {
                const diff = Math.floor((now - this.sessionStart) / 1000);
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                
                sessionDisplay.textContent = `Sesión: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
    }

    /* ===================================================================== */
    /* INICIALIZACIÓN DE TODOS LOS COMPONENTES AL CARGAR LA PÁGINA           */
    /* ===================================================================== */

    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar componentes
        window.uploader = new AdvancedFileUploader();
        window.employeeModalSystem = new EmployeeModalSystem();
        window.importValidator = new RealTimeImportValidator();
        window.employeeListManager = new EmployeeListManager();
        window.modernClock = new ModernClock();
        
        // Mostrar notificación de bienvenida
        setTimeout(() => {
            showToast('Sistema de Gestión de Empleados cargado correctamente', 'success');
        }, 1000);
        
        // Configuración adicional para elementos específicos
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    /* ===================================================================== */
    /* FUNCIONES GLOBALES PARA USO DESDE LA CONSOLA O EVENTOS EXTERNOS       */
    /* ===================================================================== */

    // Función global para mostrar notificaciones
    window.showToast = showToast;

    // Función global para abrir el modal de empleado
    window.openEmployeeModal = function(employeeId = null) {
        if (window.employeeModalSystem) {
            window.employeeModalSystem.openModal(employeeId);
        }
    };

    // Función global para abrir el modal de importación
    window.openImportModal = function() {
        if (window.importValidator) {
            window.importValidator.openModal();
        }
    };

    // Función para cambiar tema desde cualquier lugar
    window.toggleTheme = toggleTheme;

    </script>
</body>
</html>